var A=Object.defineProperty;var D=(c,e,t)=>e in c?A(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var T=(c,e,t)=>D(c,typeof e!="symbol"?e+"":e,t);import{ay as F,az as O,t as V,a0 as z,a as h,e as y,a1 as B,aA as U,ac as L,aB as I,X as S,D as H,a6 as _,aC as W,aD as v,K as k,aE as G,$}from"./babylon-CE90AqKx.js";import"./loaders-Dq7FhDUI.js";import"./gui-DJfFYA57.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const q=async()=>{let c=document.getElementById("renderCanvas");c||(console.log("Creating new canvas element"),c=document.createElement("canvas"),c.id="renderCanvas",c.style.width="100%",c.style.height="100%",c.style.touchAction="none",c.style.outline="none",document.body.appendChild(c));const e=new F(c,!0,{preserveDrawingBuffer:!0,stencil:!0,disableWebGL2Support:!1,powerPreference:"high-performance"});return console.log("Using WebGL engine"),window.addEventListener("resize",()=>{e.resize()}),c.addEventListener("webglcontextlost",t=>{console.error("WebGL context lost. Trying to restore..."),t.preventDefault(),setTimeout(()=>{e.engineInstrumentation.isDirty=!1,e.engineInstrumentation.lastStartDispatch=e.timeStep,e.engineInstrumentation.lastDispatch=e.timeStep,e.engineInstrumentation.lastClear=e.timeStep,window.location.reload()},1e3)}),{engine:e,canvas:c}},K=c=>{const e=new O(c);e.autoClear=!0,e.autoClearDepthAndStencil=!0,e.skipFrustumClipping=!0,e.clearColor=new V(.5,.75,.95,1);const t=new z("hemisphericLight",new h(0,1,0),e);t.intensity=.8,t.diffuse=new y(1,1,1),t.groundColor=new y(.5,.5,.5);const i=new B("directionalLight",new h(.5,-1,.5),e);i.intensity=.6,i.diffuse=new y(1,1,1);const s={getShadowMap:()=>({renderList:[]}),addShadowCaster:()=>{},dispose:()=>{}},o=new U(e,10);return o.update(new h(0,0,0),new h(1,0,0),new h(0,1,0),new h(0,0,1)),o.xAxis&&o.xAxis.parent&&(o.xAxis.parent=null,o.yAxis.parent=null,o.zAxis.parent=null),{scene:e,shadowGenerator:s,axesViewer:o}};function Y(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){const e=Math.random()*16|0;return(c==="x"?e:e&3|8).toString(16)})}const E=class E{constructor(e,t=null,i={}){E.instanceCounter++,this.creationTime=new Date().toISOString(),this.instanceNumber=E.instanceCounter,this.id=Y(),this.uniqueId=`${this.constructor.name}_${this.instanceNumber}`,this.scene=e,this.options=i,this.rootNode=new L(this.uniqueId,e),this.initialValues={position:t?t.clone():null},t&&(this.rootNode.position=t),this.debug=i.debug||!1,this._isVisible=!0,this.debugLog(`Created ${this.constructor.name} at position (${(t==null?void 0:t.x.toFixed(2))||"null"}, ${(t==null?void 0:t.y.toFixed(2))||"null"}, ${(t==null?void 0:t.z.toFixed(2))||"null"})`)}getName(){let e=this.constructor.name;return e.endsWith("Model")&&(e=e.slice(0,-5)),e==="SingleCut"?"CUT":e.replace(/([A-Z])/g," $1").trim()}debugLog(...e){this.debug&&console.log(`[${this.constructor.name} Debug]`,...e)}updateLOD(e){}setVisible(e){this._isVisible=e,this.rootNode&&(this.rootNode.setEnabled(e),this.debugLog(`Set ${this.constructor.name} visibility to ${e}`))}isVisible(){return this._isVisible}getId(){return this.id}dispose(){this.rootNode&&(this.rootNode.dispose(),this.debugLog(`Disposed ${this.constructor.name}`))}logModelDetails(){if(console.group(`${this.constructor.name} Details`),console.log("Type:",this.constructor.name),this.initialValues&&(console.group("Initial Values"),this.initialValues.position&&console.log("Position:",{x:this.initialValues.position.x.toFixed(2),y:this.initialValues.position.y.toFixed(2),z:this.initialValues.position.z.toFixed(2)}),this.initialValues.radius!==void 0&&console.log("Radius:",this.initialValues.radius.toFixed(2)),this.initialValues.rotationAngle!==void 0&&console.log("Rotation:",this.initialValues.rotationAngle.toFixed(2)+"°"),console.groupEnd()),this.rootNode){console.group("Current Transform");const e=this.rootNode.position;console.log("Position:",{x:e.x.toFixed(2),y:e.y.toFixed(2),z:e.z.toFixed(2)});const t=this.rootNode.rotation;console.log("Rotation:",{x:(t.x*180/Math.PI).toFixed(2)+"°",y:(t.y*180/Math.PI).toFixed(2)+"°",z:(t.z*180/Math.PI).toFixed(2)+"°"}),console.log("Enabled:",this.rootNode.isEnabled()),console.groupEnd()}if(this.options&&(console.group("Options"),this.options.radius!==void 0&&console.log("Radius:",this.options.radius.toFixed(2)),this.options.outerRadius!==void 0&&console.log("Outer Radius:",this.options.outerRadius.toFixed(2)),this.options.innerRadius!==void 0&&console.log("Inner Radius:",this.options.innerRadius.toFixed(2)),this.options.singleCutRadius!==void 0&&console.log("SingleCut Radius:",this.options.singleCutRadius.toFixed(2)),this.options.rotationAngle!==void 0&&console.log("Rotation Angle:",this.options.rotationAngle.toFixed(2)+"°"),this.options.parent&&console.log("Parent:",this.options.parent.uniqueId||"Unknown"),console.groupEnd()),this.initialValues&&this.initialValues.position&&this.rootNode){console.group("Changes from Initial State");const e=this.initialValues.position,t=this.rootNode.position;console.log("Position Delta:",{x:(t.x-e.x).toFixed(2),y:(t.y-e.y).toFixed(2),z:(t.z-e.z).toFixed(2)}),this.initialValues.radius!==void 0&&this.options.radius!==void 0&&console.log("Radius Delta:",(this.options.radius-this.initialValues.radius).toFixed(2)),this.initialValues.rotationAngle!==void 0&&this.options.rotationAngle!==void 0&&console.log("Rotation Delta:",(this.options.rotationAngle-this.initialValues.rotationAngle).toFixed(2)+"°"),console.groupEnd()}console.groupEnd()}};T(E,"instanceCounter",0);let P=E;class Z extends P{constructor(e,t=5e3,i=new h(0,0,0),s={}){super(e,i,{...s,name:"ground"}),this.size=t,this.mesh=null,this.createGround()}createGround(){this.debugLog("Creating ground mesh"),this.mesh=I.CreateGround("ground",{width:this.size,height:this.size,subdivisions:32},this.scene),this.mesh.position=new h(0,0,0),this.mesh.parent=this.rootNode;const e=new S("groundMaterial",this.scene);e.diffuseColor=new y(.2,.5,.2),e.specularColor=new y(0,0,0);const t=1024,i=new H("gridTexture",t,this.scene,!0),s=i.getContext();s.fillStyle="#366936",s.fillRect(0,0,t,t),s.lineWidth=2,s.strokeStyle="#488A48",s.lineWidth=4;const o=t/10;for(let n=0;n<=10;n++){const r=n*o;s.beginPath(),s.moveTo(0,r),s.lineTo(t,r),s.stroke(),s.beginPath(),s.moveTo(r,0),s.lineTo(r,t),s.stroke()}i.update(),i.uScale=this.size/100,i.vScale=this.size/100,e.diffuseTexture=i,e.useSpecularOverAlpha=!1,this.mesh.material=e,this.mesh.checkCollisions=!0,this.debugLog("Ground mesh created successfully")}getName(){return"Ground"}setVisible(e){super.setVisible(e),this.mesh&&(this.mesh.isVisible=e)}dispose(){this.mesh&&(this.mesh.dispose(),this.mesh=null),super.dispose()}}class N extends P{constructor(e,t,i={}){super(e,t,i),this.childModels=[]}addChild(e){e&&e.rootNode&&(e.rootNode.parent=this.rootNode,this.childModels.push(e),this.debugLog(`Added child model: ${e.constructor.name}`))}addChildren(e){Array.isArray(e)&&e.forEach(t=>this.addChild(t))}getChildren(){return[...this.childModels]}setVisible(e){console.log(`CompositeModel.setVisible(${e}) called for ${this.constructor.name}`),super.setVisible(e),this.rootNode&&console.log(`${this.constructor.name} rootNode.isEnabled(): ${this.rootNode.isEnabled()}`),this.childModels.forEach(t=>{t&&typeof t.setVisible=="function"?t.setVisible(e):console.warn("Child model doesn't have setVisible method:",t)}),this.rootNode&&console.log(`${this.constructor.name} final rootNode.isEnabled(): ${this.rootNode.isEnabled()}`)}updateLOD(e){this.childModels.forEach(t=>{t.updateLOD(e)})}getAllMeshes(e=null){const t=[];return this.childModels.forEach(i=>{e&&i[e]&&Array.isArray(i[e])?t.push(...i[e]):i instanceof N&&t.push(...i.getAllMeshes(e))}),t}dispose(){this.childModels.forEach(e=>{e.dispose()}),this.childModels=[],super.dispose()}}class Q extends P{constructor(e,t=new h(0,0,0),i={}){const s={height:1e3,radius:5,color:new y(.7,.7,.7),markerInterval:100,mainMarkerInterval:500,name:"pipe"};super(e,t,{...s,...i}),this.createPipe(),this.createHeightMarkers()}createPipe(){const e=I.CreateCylinder("pipe",{height:this.options.height,diameter:this.options.radius*2,tessellation:24},this.scene);e.position.y=this.options.height/2;const t=new S("pipeMaterial",this.scene);t.diffuseColor=this.options.color,t.specularColor=new y(.3,.3,.3),e.material=t,e.checkCollisions=!0,e.parent=this.rootNode,this.pipeMesh=e}createHeightMarkers(){const e=[],t=Math.floor(this.options.height/this.options.markerInterval)+1;for(let i=0;i<t;i++){const s=i*this.options.markerInterval;if(s===0)continue;const o=s%this.options.mainMarkerInterval===0,n=this.createRingMarker(this.options.radius+.2,o?.5:.2,o?new y(1,0,0):new y(1,1,0));if(n.position.y=s,o){const r=this.createHeightText(s,n);r.parent=this.rootNode}n.parent=this.rootNode,e.push(n)}this.markers=e}createRingMarker(e,t,i){const s=I.CreateTorus("heightMarker",{diameter:e*2,thickness:t,tessellation:32},this.scene),o=new S("ringMaterial",this.scene);return o.diffuseColor=i,o.specularColor=new y(.1,.1,.1),s.material=o,s}createHeightText(e,t){const i=I.CreatePlane("heightText",{width:10,height:2},this.scene);i.position=new h(this.options.radius+5,0,0);const s=new S("textMaterial",this.scene);return s.diffuseColor=new y(.8,.8,.8),s.backFaceCulling=!1,s.specularColor=new y(0,0,0),i.material=s,i.billboardMode=_.BILLBOARDMODE_ALL,i.parent=t,i}getName(){return"Pipe"}dispose(){this.pipeMesh&&this.pipeMesh.dispose(),this.markers&&this.markers.forEach(e=>e.dispose()),super.dispose()}setVisible(e){this._isVisible=e,console.log(`PipeModel setVisible called with ${e}`),this.rootNode&&(console.log(`Setting PipeModel rootNode enabled to ${e}`),this.rootNode.setEnabled(e)),this.pipeMesh&&(console.log(`Setting PipeModel pipeMesh visibility to ${e}`),this.pipeMesh.isVisible=e,this.pipeMesh.refreshBoundingInfo()),this.markers&&this.markers.forEach(t=>{t.isVisible=e}),this.pipeMesh&&console.log(`PipeModel after change: mesh visible=${this.pipeMesh.isVisible}, rootNode enabled=${this.rootNode?this.rootNode.isEnabled():"N/A"}`)}}class X extends P{constructor(e,t=new h(0,0,0),i={}){const s={height:1e3,width:50,depth:2,color:new y(.2,.6,.8),name:"panel"};super(e,t,{...s,...i}),this.initialRotation=null,this.panelIndex=-1,this.createPanel()}createPanel(){const e=I.CreateBox("panel",{height:this.options.height,width:this.options.width,depth:this.options.depth},this.scene);e.position.y=this.options.height/2;const t=new S("panelMaterial",this.scene);t.diffuseColor=this.options.color,t.specularColor=new y(.3,.3,.3),e.material=t,e.checkCollisions=!0,e.parent=this.rootNode,this.panelMesh=e}storeInitialRotation(){if(!this.initialRotation&&this.rootNode&&(this.initialRotation=this.rootNode.rotation.clone(),console.log(`Stored initial rotation for panel ${this.panelIndex+1}: (${this.radToDeg(this.initialRotation.x)}°, ${this.radToDeg(this.initialRotation.y)}°, ${this.radToDeg(this.initialRotation.z)}°)`),this.rotationState&&this.panelIndex>=0)){const e=this.rotationState.defaultAngles[this.panelIndex];console.log(`Panel ${this.panelIndex+1} default angle from shared state: ${e==null?void 0:e.toFixed(1)}°`)}}applyRotationDelta(e,t=!0){if(!this.rootNode)return;this.storeInitialRotation(),this.rotationState&&this.panelIndex>=0&&(this.rotationState.currentDelta=e,this.rotationState.defaultAngles&&this.rotationState.defaultAngles[this.panelIndex]!==void 0&&(this.rotationState.currentAngles[this.panelIndex]=this.rotationState.defaultAngles[this.panelIndex]+e,console.log(`Panel ${this.panelIndex+1} current angle in shared state updated to: ${this.rotationState.currentAngles[this.panelIndex].toFixed(1)}°`))),this.initialRotation?(this.rootNode.rotation=this.initialRotation.clone(),console.log(`Panel ${this.panelIndex+1} initial rotation: (${this.radToDeg(this.initialRotation.y)}°)`)):(console.warn(`Panel ${this.panelIndex+1} missing initial rotation, creating one`),this.initialRotation=new h(0,0,0),this.rootNode.rotation=this.initialRotation.clone());const i=e*Math.PI/180;let s=i;if(this.rotationState&&this.rotationState.defaultAngles&&this.panelIndex>=0){const o=this.rotationState.defaultAngles[this.panelIndex]||0;s=o*Math.PI/180+i,console.log(`Panel ${this.panelIndex+1} applying total rotation of ${this.radToDeg(s)}° (default ${o}° + delta ${e}°)`)}this.rootNode.rotation.y=s,console.log(`Panel ${this.panelIndex+1} rotation after update: Y=${this.radToDeg(this.rootNode.rotation.y)}°`),this.forceUpdate(t)}forceUpdate(e=!0){if(this.rootNode&&this.rootNode.computeWorldMatrix(!0),this.panelMesh&&(this.panelMesh.markAsDirty(),this.panelMesh.refreshBoundingInfo(),this.panelMesh.computeWorldMatrix(!0)),e&&this.scene&&this.scene.activeCamera)try{this.scene.render()}catch(t){console.warn(`PanelModel: Couldn't render scene, this is normal during initialization: ${t.message}`)}}getCurrentDelta(){return this.rotationState?this.rotationState.currentDelta:0}getCurrentTotalAngle(){if(this.rotationState&&this.panelIndex>=0){const e=this.rotationState.defaultAngles[this.panelIndex]||0,t=this.rotationState.currentDelta||0;return e+t}return this.rootNode?parseFloat(this.radToDeg(this.rootNode.rotation.y)):0}radToDeg(e){return(e*180/Math.PI).toFixed(1)}setVisible(e){this._isVisible=e,console.log(`PanelModel setVisible called with ${e}`),this.rootNode&&(console.log(`Setting PanelModel rootNode enabled to ${e}`),this.rootNode.setEnabled(e)),this.panelMesh&&(console.log(`Setting PanelModel panelMesh visibility to ${e}`),this.panelMesh.isVisible=e,this.panelMesh.refreshBoundingInfo()),this.panelMesh&&console.log(`PanelModel after change: mesh visible=${this.panelMesh.isVisible}, rootNode enabled=${this.rootNode?this.rootNode.isEnabled():"N/A"}`)}dispose(){this.panelMesh&&this.panelMesh.dispose(),super.dispose()}getName(){return"Panel"}}class R extends N{constructor(e,t=new h(0,0,0),i={}){const s={cornerCount:6,radius:21,debug:!1,rotationAngle:0,parent:null};if(super(e,t,{...s,...i}),this.initialValues={...this.initialValues,radius:this.options.radius,rotationAngle:this.options.rotationAngle},this.setupTransformNodes(),this.options.rotationAngle!==0){const o=this.getRotation();o.angle=this.options.rotationAngle}}setupTransformNodes(){this.cornerNodes=[],this.sideNodes=[];const e=this.options.cornerCount;for(let t=0;t<e;t++){const i=this.calculateCornerPosition(t),s=`${this.uniqueId}_corner_${t}`,o=new L(s,this.scene);o.position=i,o.parent=this.rootNode,this.cornerNodes.push(o),this.debugLog(`Created corner node ${t} at position (${i.x.toFixed(2)}, ${i.y.toFixed(2)}, ${i.z.toFixed(2)})`)}for(let t=0;t<e;t++){const i=(t+1)%e,s=this.cornerNodes[t].position,o=this.cornerNodes[i].position,n=s.add(o).scale(.5),r=`${this.uniqueId}_side_${t}`,a=new L(r,this.scene);a.position=n,a.parent=this.rootNode;const l=n.normalize(),d=Math.atan2(l.z,l.x);a.rotation=new h(0,d,0),this.sideNodes.push(a),this.debugLog(`Created side node ${t} at position (${n.x.toFixed(2)}, ${n.y.toFixed(2)}, ${n.z.toFixed(2)})`)}}calculateCornerPosition(e){const t=this.options.cornerCount,i=e*2*Math.PI/t,s=this.options.radius*Math.cos(i),o=this.options.radius*Math.sin(i);return new h(s,0,o)}calculateSidePosition(e){const t=this.options.cornerCount,i=e,s=(e+1)%t,o=this.calculateCornerPosition(i),n=this.calculateCornerPosition(s);return o.add(n).scale(.5)}calculateSideDirection(e){return this.calculateSidePosition(e).normalize()}calculateCornerAngle(e,t){const i=this.options.cornerCount,s=e*2*Math.PI/i,o=t*2*Math.PI/i;return Math.abs(o-s)}calculateCornerDistance(e,t){const i=this.calculateCornerPosition(e),s=this.calculateCornerPosition(t);return h.Distance(i,s)}getSideLength(){return this.calculateCornerDistance(0,1)}getCornerToCornerDistance(){const t=this.options.cornerCount/2;return t%1!==0?this.options.radius*2:this.calculateCornerDistance(0,t)}getSideToSideDistance(){return this.options.radius*Math.sqrt(3)}updateRadius(e){if(this.options.radius===e)return;const t=this.options.radius;this.options.radius=e,this.debugLog(`Updating radius from ${t.toFixed(2)} to ${e.toFixed(2)}`),this.updateNodePositions()}updateNodePositions(){const e=this.options.cornerCount;for(let t=0;t<e;t++)if(this.cornerNodes[t]){const i=this.calculateCornerPosition(t);this.cornerNodes[t].position=i}for(let t=0;t<e;t++)if(this.sideNodes[t]){const i=(t+1)%e,s=this.cornerNodes[t].position,o=this.cornerNodes[i].position,n=s.add(o).scale(.5);this.sideNodes[t].position=n;const r=n.normalize(),a=Math.atan2(r.z,r.x);this.sideNodes[t].rotation=new h(0,a,0)}}getRotation(){return this._rotation||(this._rotation={angle:0,min:0,max:360,default:0}),this._rotation}getChildrenRotations(e=null){return null}getDefaultRadius(){return this.options.radius}getMinRadius(){return 10}getMaxRadius(){return 100}getDefaultRotation(){return this.options.rotationAngle}getMinRotation(){return 0}getMaxRotation(){return 360}radToDeg(e){return(e*180/Math.PI).toFixed(2)+"°"}degToRad(e){return e*Math.PI/180}calculateSideDistance(){return this.options.radius*Math.sqrt(3)}getRadius(){return this._radius||(this._radius={value:this.options.radius,min:this.getMinRadius(),max:this.getMaxRadius(),default:this.getDefaultRadius()},Object.defineProperty(this._radius,"value",{get:()=>this.options.radius,set:e=>{this.options.radius!==e&&this.updateRadius(e)}})),this._radius}dispose(){this.cornerNodes&&(this.cornerNodes.forEach(e=>{e&&e.dispose()}),this.cornerNodes=[]),this.sideNodes&&(this.sideNodes.forEach(e=>{e&&e.dispose()}),this.sideNodes=[]),super.dispose()}getChildrenRadii(e=null){return null}}class b extends R{constructor(e,t=new h(0,0,0),i={}){const s={pipeRadius:1,pipeHeight:1e3,pipeColor:new y(.7,.7,.7),panelWidth:50,panelHeight:1e3,panelDepth:.1,panelColor:new y(.2,.6,.8),skipPanels:!1};super(e,t,{...s,...i}),this.createModels(),this.debugLog("SingleCUT model created with ID:",this.id)}createModels(){this.pipes=[],this.panels=[],this.initializePanelRotations(),this.debugLog("Creating SingleCUT model with",this.options.cornerCount,"pipes and panels"),this.createPipes(),this.options.skipPanels?this.debugLog("Skipping panel creation as requested by skipPanels option"):this.createPanels(),this.debugLog("SingleCUT model creation complete"),this.debugLog("Panel rotation state after initialization:",JSON.stringify(this.panelRotations))}initializePanelRotations(){const e=this.options.cornerCount||6;this.rotations=[],this.panelRotations={currentDelta:0,defaultAngles:[],currentAngles:[]};for(let t=0;t<e;t++){const s=this.getDefaultPanelRotation(t)*180/Math.PI,o={id:`panel-${t}`,name:`Panel ${t+1}`,index:t,baseRotation:s,value:s,delta:0};this.rotations.push(o),this.panelRotations.defaultAngles[t]=s,this.panelRotations.currentAngles[t]=s}this.debugLog("Panel rotations initialized:"),this.debugLog(`- Created ${this.rotations.length} rotation entries`),this.debugLog(`- Default angles: ${this.rotations.map(t=>t.value.toFixed(1)+"°").join(", ")}`)}createPipes(){const e=this.options.cornerCount;for(let t=0;t<e;t++){const i=this.cornerNodes[t].position.clone();this.debugLog(`Pipe ${t+1}: Position (${i.x.toFixed(2)}, 0, ${i.z.toFixed(2)})`);const s=new Q(this.scene,i,{height:this.options.pipeHeight,radius:this.options.pipeRadius,color:this.options.pipeColor});if(s.rootNode.parent=this.rootNode,this.pipes.push(s),this.options.parent&&typeof this.options.parent.isElementPermanentlyHidden=="function"){const o=this.options.parent.childModels?this.options.parent.childModels.indexOf(this):-1;o!==-1&&this.options.parent.isElementPermanentlyHidden(o,"pipe",t)&&(this.debugLog(`Permanently hiding Pipe #${t+1} as requested by parent model`),s.pipeMesh.isVisible=!1,s.rootNode.setEnabled(!1))}}}createPanels(){const e=this.options.cornerCount;(!this.rotations||this.rotations.length===0)&&(this.debugLog("Panel rotation data not initialized, doing it now"),this.initializePanelRotations());for(let t=0;t<e;t++){const i=(t+1)%e;this.debugLog(`Creating panel ${t+1} between pipes ${t+1} and ${i+1}`);const s=this.cornerNodes[t].position.clone(),o=this.cornerNodes[i].position.clone(),n=this.calculatePanelTransform(t,s,o),r=this.rotations[t];this.debugLog(`Panel #${t+1} default angle: ${r.baseRotation.toFixed(1)}°`);const a=this.createPanel(n.position,n.rotation,n.width,t);if(a.rotationState=this.panelRotations,a.panelIndex=t,a.rotationData=r,this.panels.push(a),this.options.parent&&typeof this.options.parent.isElementPermanentlyHidden=="function"){const l=this.options.parent.childModels?this.options.parent.childModels.indexOf(this):-1;l!==-1&&this.options.parent.isElementPermanentlyHidden(l,"panel",t)&&(this.debugLog(`Permanently hiding Panel #${t+1} as requested by parent model`),a.panelMesh.isVisible=!1,a.rootNode.setEnabled(!1))}}this.debugLog("Panel rotation state after panel creation:"),this.debugLog("  Default angles:",this.panelRotations.defaultAngles.map(t=>t.toFixed(1)+"°").join(", ")),this.debugLog("  Current angles:",this.panelRotations.currentAngles.map(t=>t.toFixed(1)+"°").join(", ")),this.debugLog("  Current delta:",this.panelRotations.currentDelta+"°")}calculatePanelTransform(e,t,i){const s=t.add(i).scale(.5),o=i.subtract(t).normalize(),n=Math.atan2(o.z,o.x),r=new h(0,n,0),a=h.Distance(t,i),l=this.options.pipeRadius||.5,d=a-2*l;return this.debugLog(`Panel Transform: Position (${s.x.toFixed(2)}, ${s.y.toFixed(2)}, ${s.z.toFixed(2)}), Rotation Y: ${this.radToDeg(n)}, Width: ${d.toFixed(2)}`),{position:s,rotation:r,width:d}}createPanel(e,t,i,s){const o=this.rotations[s],n=new X(this.scene,e,{height:this.options.panelHeight,width:i,depth:this.options.panelDepth,color:this.options.pipeColor,rotation:o});n.rootNode.rotation=t.clone(),this.debugLog(`Panel ${s+1}: Initial pipe-to-pipe rotation: X: ${this.radToDeg(t.x)}, Y: ${this.radToDeg(t.y)}, Z: ${this.radToDeg(t.z)}`),n.rotation=o,n.rotationState=this.panelRotations,n.panelIndex=s;const r=n.rootNode.rotation;return this.debugLog(`Panel ${s+1}: Position (${e.x.toFixed(2)}, ${e.y.toFixed(2)}, ${e.z.toFixed(2)}), Rotation X: ${this.radToDeg(r.x)}, Y: ${this.radToDeg(r.y)}, Z: ${this.radToDeg(r.z)}`),n.rootNode.parent=this.rootNode,n}updateLOD(e){const t=h.Distance(e,this.rootNode.position),i=2e3,s=1e3;this.pipes.forEach(o=>{const n=t<i;o.pipeMesh.isVisible=n,o.markers&&o.markers.forEach(r=>{r.isVisible=t<s})}),this.panels.forEach(o=>{o.panelMesh&&(o.panelMesh.isVisible=t<i)})}updateRadius(e){if(this.options.radius===e)return;const t=this.options.radius;super.updateRadius(e),this.debugLog(`SingleCut ${this.id}: Updated radius from ${t.toFixed(2)} to ${e.toFixed(2)} (initial: ${this.initialValues.radius.toFixed(2)}, total delta: ${(e-this.initialValues.radius).toFixed(2)})`),this.dispose(!1),this.createModels()}dispose(e=!0){this.pipes&&(this.pipes.forEach(t=>t.dispose()),this.pipes=[]),this.panels&&(this.panels.forEach(t=>t.dispose()),this.panels=[]),e&&super.dispose()}getChildren(){return[]}getDefaultPanelRotation(e){const t=this.options.cornerCount||6;if(t===6){const i=e%t;if(i===0||i===3)return Math.PI/3;if(i===1||i===4)return 0;if(i===2||i===5)return 2*Math.PI/3}return e*2*Math.PI/t}onRender(e=!0){if(!this.panels||this.panels.length===0){this.debugLog("No panels to initialize");return}this.debugLog("Initializing panels with default rotations");const t=this.panelRotations.currentDelta||0;this.panels.forEach((i,s)=>{if(i&&i.rootNode){!i.initialRotation&&i.storeInitialRotation&&i.storeInitialRotation();const o=this.rotations[s];t!==0&&(o.delta=t,o.value=o.baseRotation+t),this.debugLog(`Panel #${s+1}: Applying rotation of ${o.value.toFixed(1)}° (base: ${o.baseRotation.toFixed(1)}°, delta: ${o.delta}°)`);const n=o.value*Math.PI/180;i.rootNode.rotation.y=n,i.setVisible&&i.setVisible(!0),i.panelMesh&&(i.panelMesh.isVisible=!0),e&&this.scene&&i.rootNode&&i.rootNode.freezeWorldMatrix()}}),e&&this.scene&&this.scene.onBeforeRenderObservable.addOnce(()=>{this.panels.forEach(i=>{i&&i.rootNode&&i.rootNode.unfreezeWorldMatrix()})}),this.debugLog("Panel initialization complete")}getChildrenRotations(){return this.rotations}applyModelRotation(e){const t=e*Math.PI/180;this.rootNode&&(this.rootNode.rotation.y=t),this.options.rotationAngle=e,this.debugLog(`Applied ${this.getName()} rotation: ${e}°`)}getRotation(){return this._rotation||(this._rotation={angle:this.options.rotationAngle||0,min:0,max:360,default:this.options.rotationAngle||0},Object.defineProperty(this._rotation,"angle",{get:()=>this._rotationAngle||0,set:e=>{this._rotationAngle=e,this.applyModelRotation(e)}})),this._rotation}getName(){return"CUT"}}class j extends R{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,cornerRotationAngle:0,radius:42,visibility:{all:!0}};super(e,t,{...s,...i}),this.cornerRotations=[],this.createModels()}createModels(){this.debugLog("Creating LayerOneStarModel with 6 corner SingleCUTs");const{singleCutRadius:e,cornerRotationAngle:t}=this.options;this.cornerCuts=[];for(let i=0;i<6;i++)this.cornerRotations.push({id:`corner-${i}`,name:`Corner ${i+1}`,index:i,angle:t,min:0,max:360,default:t});for(let i=0;i<6;i++){const s=this.cornerNodes[i].position.clone(),o=new b(this.scene,s,{radius:e,rotationAngle:this.cornerRotations[i].angle,parent:this,debug:this.options.debug});this.cornerCuts.push(o),this.addChild(o)}this.debugLog("LayerOneStarModel creation complete")}getRadius(){return this._radius||(this._radius={value:this.options.radius,min:this.getMinRadius(),max:this.getMaxRadius(),default:this.getDefaultRadius()},Object.defineProperty(this._radius,"value",{get:()=>this.options.radius,set:e=>{this.options.radius!==e&&this.updateRadius(e)}})),this._radius}getChildrenRotations(){return this.cornerRotations}updateRadius(e){super.updateRadius(e);for(let t=0;t<this.cornerCuts.length;t++){const i=this.cornerCuts[t],s=this.cornerNodes[t];i&&i.rootNode&&s&&(i.rootNode.position=s.position.clone())}this.debugLog(`Updated radius to ${e}`)}getMinRadius(){return 30}getMaxRadius(){return 80}getDefaultRadius(){return 39.6}getName(){return"Layer One Star"}onRender(){this.debugLog("Initializing LayerOneStarModel"),this.cornerCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.debugLog("LayerOneStarModel initialization complete")}dispose(){this.cornerCuts=[],this.cornerRotations=[],super.dispose()}}class J extends R{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,cornerRotationAngle:0,sideRotationAngle:0,radius:84,visibility:{all:!0}};super(e,t,{...s,...i}),this.cornerRotations=[],this.sideRotations=[],this.createModels()}createModels(){this.debugLog("Creating LayerTwoStarModel with 6 corner SingleCUTs and 6 side SingleCUTs");const{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:i}=this.options;this.cornerCuts=[],this.sideCuts=[];for(let s=0;s<6;s++)this.cornerRotations.push({id:`corner-${s}`,name:`Corner ${s+1}`,index:s,angle:t,min:0,max:360,default:t});for(let s=0;s<6;s++)this.sideRotations.push({id:`side-${s}`,name:`Side ${s+1}`,index:s,angle:i,min:0,max:360,default:i});for(let s=0;s<6;s++){const o=this.cornerNodes[s].position.clone(),n=new b(this.scene,o,{radius:e,rotationAngle:this.cornerRotations[s].angle,parent:this,debug:this.options.debug});this.cornerCuts.push(n),this.addChild(n)}for(let s=0;s<6;s++){const o=(s+1)%6,n=this.cornerNodes[s].position.clone(),r=this.cornerNodes[o].position.clone(),a=n.add(r).scale(.5),l=new b(this.scene,a,{radius:e,rotationAngle:this.sideRotations[s].angle,parent:this,debug:this.options.debug});this.sideCuts.push(l),this.addChild(l)}this.debugLog("LayerTwoStarModel creation complete")}getRadius(){return this._radius||(this._radius={value:this.options.radius,min:this.getMinRadius(),max:this.getMaxRadius(),default:this.getDefaultRadius()},Object.defineProperty(this._radius,"value",{get:()=>this.options.radius,set:e=>{this.options.radius!==e&&this.updateRadius(e)}})),this._radius}getChildrenRotations(){return[...this.cornerRotations,...this.sideRotations]}updateRadius(e){super.updateRadius(e);for(let t=0;t<this.cornerCuts.length;t++){const i=this.cornerCuts[t],s=this.cornerNodes[t];i&&i.rootNode&&s&&(i.rootNode.position=s.position.clone())}for(let t=0;t<this.sideCuts.length;t++){const i=t,s=(t+1)%6,o=this.cornerNodes[i].position.clone(),n=this.cornerNodes[s].position.clone(),r=o.add(n).scale(.5),a=this.sideCuts[t];a&&a.rootNode&&(a.rootNode.position=r)}this.debugLog(`Updated radius to ${e}`)}getMinRadius(){return 60}getMaxRadius(){return 120}getDefaultRadius(){return 80}getName(){return"Layer Two Star"}onRender(){this.debugLog("Initializing LayerTwoStarModel"),this.cornerCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.sideCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.debugLog("LayerTwoStarModel initialization complete")}dispose(){this.cornerCuts=[],this.cornerRotations=[],this.sideCuts=[],this.sideRotations=[],super.dispose()}}class ee extends R{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,cornerRotationAngle:0,sideRotationAngle:0,radius:126,sidesPerCorner:2,visibility:{all:!0}};super(e,t,{...s,...i}),this.cornerRotations=[],this.sideRotations=[],this.createModels()}createModels(){this.debugLog("Creating LayerThreeStarModel with 6 corner SingleCUTs and 12 side SingleCUTs");const{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:i,sidesPerCorner:s}=this.options;this.cornerCuts=[],this.sideCuts=[];for(let o=0;o<6;o++)this.cornerRotations.push({id:`corner-${o}`,name:`Corner ${o+1}`,index:o,angle:t,min:0,max:360,default:t});for(let o=0;o<6*s;o++)this.sideRotations.push({id:`side-${o}`,name:`Side ${o+1}`,index:o,angle:i,min:0,max:360,default:i});for(let o=0;o<6;o++){const n=this.cornerNodes[o].position.clone(),r=new b(this.scene,n,{radius:e,rotationAngle:this.cornerRotations[o].angle,parent:this,debug:this.options.debug});this.cornerCuts.push(r),this.addChild(r)}for(let o=0;o<6;o++){const n=(o+1)%6,r=this.cornerNodes[o].position.clone(),a=this.cornerNodes[n].position.clone();for(let l=1;l<=s;l++){const d=l/(s+1),u=new h(r.x*(1-d)+a.x*d,r.y*(1-d)+a.y*d,r.z*(1-d)+a.z*d),f=o*s+(l-1),p=new b(this.scene,u,{radius:e,rotationAngle:this.sideRotations[f].angle,parent:this,debug:this.options.debug});this.sideCuts.push(p),this.addChild(p)}}this.debugLog(`LayerThreeStarModel creation complete with ${this.cornerCuts.length} corners and ${this.sideCuts.length} sides`)}getRadius(){return this._radius||(this._radius={value:this.options.radius,min:this.getMinRadius(),max:this.getMaxRadius(),default:this.getDefaultRadius()},Object.defineProperty(this._radius,"value",{get:()=>this.options.radius,set:e=>{this.options.radius!==e&&this.updateRadius(e)}})),this._radius}getChildrenRotations(){return[...this.cornerRotations,...this.sideRotations]}updateRadius(e){super.updateRadius(e);for(let s=0;s<this.cornerCuts.length;s++){const o=this.cornerCuts[s],n=this.cornerNodes[s];o&&o.rootNode&&n&&(o.rootNode.position=n.position.clone())}const{sidesPerCorner:t}=this.options;let i=0;for(let s=0;s<6;s++){const o=(s+1)%6,n=this.cornerNodes[s].position.clone(),r=this.cornerNodes[o].position.clone();for(let a=1;a<=t;a++)if(i<this.sideCuts.length){const l=this.sideCuts[i];if(l&&l.rootNode){const d=a/(t+1),u=new h(n.x*(1-d)+r.x*d,n.y*(1-d)+r.y*d,n.z*(1-d)+r.z*d);l.rootNode.position=u}i++}}this.debugLog(`Updated radius to ${e}`)}getMinRadius(){return 90}getMaxRadius(){return 180}getDefaultRadius(){return 126}getName(){return"Layer Three Star"}onRender(){this.debugLog("Initializing LayerThreeStarModel"),this.cornerCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.sideCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.debugLog("LayerThreeStarModel initialization complete")}dispose(){this.cornerCuts=[],this.cornerRotations=[],this.sideCuts=[],this.sideRotations=[],super.dispose()}}class te extends R{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,cornerRotationAngle:0,sideRotationAngle:0,radius:168,sidesPerCorner:3,visibility:{all:!0}};super(e,t,{...s,...i}),this.cornerRotations=[],this.sideRotations=[],this.createModels()}createModels(){this.debugLog("Creating LayerFourStarModel with 6 corner SingleCUTs and 18 side SingleCUTs");const{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:i,sidesPerCorner:s}=this.options;this.cornerCuts=[],this.sideCuts=[];for(let o=0;o<6;o++)this.cornerRotations.push({id:`corner-${o}`,name:`Corner ${o+1}`,index:o,angle:t,min:0,max:360,default:t});for(let o=0;o<6*s;o++)this.sideRotations.push({id:`side-${o}`,name:`Side ${o+1}`,index:o,angle:i,min:0,max:360,default:i});for(let o=0;o<6;o++){const n=this.cornerNodes[o].position.clone(),r=new b(this.scene,n,{radius:e,rotationAngle:this.cornerRotations[o].angle,parent:this,debug:this.options.debug});this.cornerCuts.push(r),this.addChild(r)}for(let o=0;o<6;o++){const n=(o+1)%6,r=this.cornerNodes[o].position.clone(),a=this.cornerNodes[n].position.clone();for(let l=1;l<=s;l++){const d=l/(s+1),u=new h(r.x*(1-d)+a.x*d,r.y*(1-d)+a.y*d,r.z*(1-d)+a.z*d),f=o*s+(l-1),p=new b(this.scene,u,{radius:e,rotationAngle:this.sideRotations[f].angle,parent:this,debug:this.options.debug});this.sideCuts.push(p),this.addChild(p)}}this.debugLog(`LayerFourStarModel creation complete with ${this.cornerCuts.length} corners and ${this.sideCuts.length} sides`)}getRadius(){return this._radius||(this._radius={value:this.options.radius,min:this.getMinRadius(),max:this.getMaxRadius(),default:this.getDefaultRadius()},Object.defineProperty(this._radius,"value",{get:()=>this.options.radius,set:e=>{this.options.radius!==e&&this.updateRadius(e)}})),this._radius}getChildrenRotations(){return[...this.cornerRotations,...this.sideRotations]}updateRadius(e){super.updateRadius(e);for(let s=0;s<this.cornerCuts.length;s++){const o=this.cornerCuts[s],n=this.cornerNodes[s];o&&o.rootNode&&n&&(o.rootNode.position=n.position.clone())}const{sidesPerCorner:t}=this.options;let i=0;for(let s=0;s<6;s++){const o=(s+1)%6,n=this.cornerNodes[s].position.clone(),r=this.cornerNodes[o].position.clone();for(let a=1;a<=t;a++)if(i<this.sideCuts.length){const l=this.sideCuts[i];if(l&&l.rootNode){const d=a/(t+1),u=new h(n.x*(1-d)+r.x*d,n.y*(1-d)+r.y*d,n.z*(1-d)+r.z*d);l.rootNode.position=u}i++}}this.debugLog(`Updated radius to ${e}`)}getMinRadius(){return 130}getMaxRadius(){return 210}getDefaultRadius(){return 168}getName(){return"Layer Four Star"}onRender(){this.debugLog("Initializing LayerFourStarModel"),this.cornerCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.sideCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.debugLog("LayerFourStarModel initialization complete")}dispose(){this.cornerCuts=[],this.cornerRotations=[],this.sideCuts=[],this.sideRotations=[],super.dispose()}}class ie extends N{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,rotationAngle:0,outerRadius:168,visibility:{centralCut:!0,outerRing:!0}};super(e,t,{...s,...i}),this.createModels(),this._isVisible=!1,this.rootNode&&this.rootNode.setEnabled(!1)}createModels(){this.debugLog("Creating Star Model with central CUT and four star layers");const{singleCutRadius:e,rotationAngle:t,outerRadius:i}=this.options,s=new b(this.scene,new h(0,0,0),{radius:e,rotationAngle:t,parent:this,debug:this.options.debug});this.centralCut=s,this.addChild(s);const o=new j(this.scene,new h(0,0,0),{singleCutRadius:e,cornerRotationAngle:t,parent:this,debug:this.options.debug});this.layerOneStar=o,this.addChild(o);const n=new J(this.scene,new h(0,0,0),{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:t,parent:this,debug:this.options.debug});this.layerTwoStar=n,this.addChild(n);const r=new ee(this.scene,new h(0,0,0),{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:t,parent:this,debug:this.options.debug});this.layerThreeStar=r,this.addChild(r);const a=new te(this.scene,new h(0,0,0),{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:t,parent:this,debug:this.options.debug});this.layerFourStar=a,this.addChild(a),s.setVisible(!1),o.setVisible(!1),n.setVisible(!1),r.setVisible(!1),a.setVisible(!1),this.debugLog("Star Model creation complete with all four layers")}getName(){return"Star"}onRender(){this.debugLog("Initializing Star Model"),this.centralCut&&typeof this.centralCut.onRender=="function"&&this.centralCut.onRender(),this.layerOneStar&&typeof this.layerOneStar.onRender=="function"&&this.layerOneStar.onRender(),this.layerTwoStar&&typeof this.layerTwoStar.onRender=="function"&&this.layerTwoStar.onRender(),this.layerThreeStar&&typeof this.layerThreeStar.onRender=="function"&&this.layerThreeStar.onRender(),this.layerFourStar&&typeof this.layerFourStar.onRender=="function"&&this.layerFourStar.onRender(),this.debugLog("Star Model initialization complete")}updateRadiusSettings(e,t){this.options.outerRadius=e,this.options.singleCutRadius=t;const i=this.layerOneStar?this.layerOneStar.getDefaultRadius():42,s=this.layerTwoStar?this.layerTwoStar.getDefaultRadius():84,o=this.layerThreeStar?this.layerThreeStar.getDefaultRadius():126,n=this.layerFourStar?this.layerFourStar.getDefaultRadius():168,r=e/n;if(this.layerOneStar){const a=this.layerOneStar.getRadius();a&&(a.value=i*r)}if(this.layerTwoStar){const a=this.layerTwoStar.getRadius();a&&(a.value=s*r)}if(this.layerThreeStar){const a=this.layerThreeStar.getRadius();a&&(a.value=o*r)}if(this.layerFourStar){const a=this.layerFourStar.getRadius();a&&(a.value=e)}this.debugLog(`Updated radius settings: outerRadius=${e}, singleCutRadius=${t}, scaleFactor=${r}`)}}class se extends R{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,cornerRotationAngle:30,radius:36.37,visibility:{all:!0}};super(e,t,{...s,...i}),this.cornerRotations=[],this.createModels()}createModels(){this.debugLog("Creating LayerOneRingModel with 6 corner SingleCUTs");const{singleCutRadius:e,cornerRotationAngle:t}=this.options;this.cornerCuts=[];for(let i=0;i<6;i++)this.cornerRotations.push({id:`corner-${i}`,name:`Corner ${i+1}`,index:i,angle:t,min:0,max:360,default:t});for(let i=0;i<6;i++){const s=this.cornerNodes[i].position.clone(),o=new b(this.scene,s,{radius:e,rotationAngle:this.cornerRotations[i].angle,parent:this,debug:this.options.debug});this.cornerCuts.push(o),this.addChild(o)}this.debugLog("LayerOneRingModel creation complete")}getRadius(){return this._radius||(this._radius={value:this.options.radius,min:this.getMinRadius(),max:this.getMaxRadius(),default:this.getDefaultRadius()},Object.defineProperty(this._radius,"value",{get:()=>this.options.radius,set:e=>{this.options.radius!==e&&this.updateRadius(e)}})),this._radius}getChildrenRotations(){return this.cornerRotations}updateRadius(e){super.updateRadius(e);for(let t=0;t<this.cornerCuts.length;t++){const i=this.cornerCuts[t],s=this.cornerNodes[t];i&&i.rootNode&&s&&(i.rootNode.position=s.position.clone())}this.debugLog(`Updated radius to ${e}`)}getName(){return"Layer One Ring"}onRender(){this.debugLog("Initializing LayerOneRingModel"),this.cornerCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.debugLog("LayerOneRingModel initialization complete")}dispose(){this.cornerCuts=[],this.cornerRotations=[],super.dispose()}}class oe extends R{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,cornerRotationAngle:30,sideRotationAngle:30,radius:72.8,visibility:{all:!0}};super(e,t,{...s,...i}),this.cornerRotations=[],this.sideRotations=[],this.createModels()}createModels(){this.debugLog("Creating LayerTwoRingModel with 6 corner SingleCUTs and 6 side SingleCUTs");const{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:i}=this.options;this.cornerCuts=[],this.sideCuts=[];for(let s=0;s<6;s++)this.cornerRotations.push({id:`corner-${s}`,name:`Corner ${s+1}`,index:s,angle:t,min:0,max:360,default:t});for(let s=0;s<6;s++)this.sideRotations.push({id:`side-${s}`,name:`Side ${s+1}`,index:s,angle:i,min:0,max:360,default:i});for(let s=0;s<6;s++){const o=this.cornerNodes[s].position.clone(),n=new b(this.scene,o,{radius:e,rotationAngle:this.cornerRotations[s].angle,parent:this,debug:this.options.debug});this.cornerCuts.push(n),this.addChild(n)}for(let s=0;s<6;s++){const o=(s+1)%6,n=this.cornerNodes[s].position.clone(),r=this.cornerNodes[o].position.clone(),a=n.add(r).scale(.5),l=new b(this.scene,a,{radius:e,rotationAngle:this.sideRotations[s].angle,parent:this,debug:this.options.debug});this.sideCuts.push(l),this.addChild(l)}this.debugLog("LayerTwoRingModel creation complete")}getRadius(){return this._radius||(this._radius={value:this.options.radius,min:this.getMinRadius(),max:this.getMaxRadius(),default:this.getDefaultRadius()},Object.defineProperty(this._radius,"value",{get:()=>this.options.radius,set:e=>{this.options.radius!==e&&this.updateRadius(e)}})),this._radius}getChildrenRotations(){return[...this.cornerRotations,...this.sideRotations]}updateRadius(e){super.updateRadius(e);for(let t=0;t<this.cornerCuts.length;t++){const i=this.cornerCuts[t],s=this.cornerNodes[t];i&&i.rootNode&&s&&(i.rootNode.position=s.position.clone())}for(let t=0;t<this.sideCuts.length;t++){const i=this.sideCuts[t],s=this.sideNodes[t];i&&i.rootNode&&s&&(i.rootNode.position=s.position.clone())}this.debugLog(`Updated radius to ${e}`)}getName(){return"Layer Two Ring"}getMinRadius(){return 40}getMaxRadius(){return 120}getDefaultRadius(){return 72.8}onRender(){this.debugLog("Initializing LayerTwoRingModel"),this.cornerCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.sideCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.debugLog("LayerTwoRingModel initialization complete")}dispose(){this.cornerCuts=[],this.cornerRotations=[],this.sideCuts=[],this.sideRotations=[],super.dispose()}}class ne extends R{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,cornerRotationAngle:30,sideRotationAngle:30,radius:109.2,sidesPerCorner:2,visibility:{all:!0}};super(e,t,{...s,...i}),this.cornerRotations=[],this.sideRotations=[],this.createModels()}createModels(){this.debugLog("Creating LayerThreeRingModel with 6 corner SingleCUTs and 12 side SingleCUTs");const{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:i,sidesPerCorner:s}=this.options;this.cornerCuts=[],this.sideCuts=[];for(let o=0;o<6;o++)this.cornerRotations.push({id:`corner-${o}`,name:`Corner ${o+1}`,index:o,angle:t,min:0,max:360,default:t});for(let o=0;o<6*s;o++)this.sideRotations.push({id:`side-${o}`,name:`Side ${o+1}`,index:o,angle:i,min:0,max:360,default:i});for(let o=0;o<6;o++){const n=this.cornerNodes[o].position.clone(),r=new b(this.scene,n,{radius:e,rotationAngle:this.cornerRotations[o].angle,parent:this,debug:this.options.debug});this.cornerCuts.push(r),this.addChild(r)}for(let o=0;o<6;o++){const n=(o+1)%6,r=this.cornerNodes[o].position.clone(),a=this.cornerNodes[n].position.clone();for(let l=1;l<=s;l++){const d=l/(s+1),u=new h(r.x*(1-d)+a.x*d,r.y*(1-d)+a.y*d,r.z*(1-d)+a.z*d),f=o*s+(l-1),p=new b(this.scene,u,{radius:e,rotationAngle:this.sideRotations[f].angle,parent:this,debug:this.options.debug});this.sideCuts.push(p),this.addChild(p)}}this.debugLog(`LayerThreeRingModel creation complete with ${this.cornerCuts.length} corners and ${this.sideCuts.length} sides`)}getRadius(){return this._radius||(this._radius={value:this.options.radius,min:this.getMinRadius(),max:this.getMaxRadius(),default:this.getDefaultRadius()},Object.defineProperty(this._radius,"value",{get:()=>this.options.radius,set:e=>{this.options.radius!==e&&this.updateRadius(e)}})),this._radius}getChildrenRotations(){return[...this.cornerRotations,...this.sideRotations]}updateRadius(e){super.updateRadius(e);for(let s=0;s<this.cornerCuts.length;s++){const o=this.cornerCuts[s],n=this.cornerNodes[s];o&&o.rootNode&&n&&(o.rootNode.position=n.position.clone())}const{sidesPerCorner:t}=this.options;let i=0;for(let s=0;s<6;s++){const o=(s+1)%6,n=this.cornerNodes[s].position.clone(),r=this.cornerNodes[o].position.clone();for(let a=1;a<=t;a++)if(i<this.sideCuts.length){const l=this.sideCuts[i];if(l&&l.rootNode){const d=a/(t+1),u=new h(n.x*(1-d)+r.x*d,n.y*(1-d)+r.y*d,n.z*(1-d)+r.z*d);l.rootNode.position=u}i++}}this.debugLog(`Updated radius to ${e}`)}getName(){return"Layer Three Ring"}getMinRadius(){return 80}getMaxRadius(){return 180}getDefaultRadius(){return 109.2}onRender(){this.debugLog("Initializing LayerThreeRingModel"),this.cornerCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.sideCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.debugLog("LayerThreeRingModel initialization complete")}dispose(){this.cornerCuts=[],this.cornerRotations=[],this.sideCuts=[],this.sideRotations=[],super.dispose()}}class re extends R{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,cornerRotationAngle:30,sideRotationAngle:30,radius:145.6,sidesPerCorner:3,visibility:{all:!0}};super(e,t,{...s,...i}),this.cornerRotations=[],this.sideRotations=[],this.createModels()}createModels(){this.debugLog("Creating LayerFourRingModel with 6 corner SingleCUTs and 18 side SingleCUTs");const{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:i,sidesPerCorner:s}=this.options;this.cornerCuts=[],this.sideCuts=[];for(let o=0;o<6;o++)this.cornerRotations.push({id:`corner-${o}`,name:`Corner ${o+1}`,index:o,angle:t,min:0,max:360,default:t});for(let o=0;o<6*s;o++)this.sideRotations.push({id:`side-${o}`,name:`Side ${o+1}`,index:o,angle:i,min:0,max:360,default:i});for(let o=0;o<6;o++){const n=this.cornerNodes[o].position.clone(),r=new b(this.scene,n,{radius:e,rotationAngle:this.cornerRotations[o].angle,parent:this,debug:this.options.debug});this.cornerCuts.push(r),this.addChild(r)}for(let o=0;o<6;o++){const n=(o+1)%6,r=this.cornerNodes[o].position.clone(),a=this.cornerNodes[n].position.clone();for(let l=1;l<=s;l++){const d=l/(s+1),u=new h(r.x*(1-d)+a.x*d,r.y*(1-d)+a.y*d,r.z*(1-d)+a.z*d),f=o*s+(l-1),p=new b(this.scene,u,{radius:e,rotationAngle:this.sideRotations[f].angle,parent:this,debug:this.options.debug});this.sideCuts.push(p),this.addChild(p)}}this.debugLog(`LayerFourRingModel creation complete with ${this.cornerCuts.length} corners and ${this.sideCuts.length} sides`)}getRadius(){return this._radius||(this._radius={value:this.options.radius,min:this.getMinRadius(),max:this.getMaxRadius(),default:this.getDefaultRadius()},Object.defineProperty(this._radius,"value",{get:()=>this.options.radius,set:e=>{this.options.radius!==e&&this.updateRadius(e)}})),this._radius}getChildrenRotations(){return[...this.cornerRotations,...this.sideRotations]}updateRadius(e){super.updateRadius(e);for(let s=0;s<this.cornerCuts.length;s++){const o=this.cornerCuts[s],n=this.cornerNodes[s];o&&o.rootNode&&n&&(o.rootNode.position=n.position.clone())}const{sidesPerCorner:t}=this.options;let i=0;for(let s=0;s<6;s++){const o=(s+1)%6,n=this.cornerNodes[s].position.clone(),r=this.cornerNodes[o].position.clone();for(let a=1;a<=t;a++)if(i<this.sideCuts.length){const l=this.sideCuts[i];if(l&&l.rootNode){const d=a/(t+1),u=new h(n.x*(1-d)+r.x*d,n.y*(1-d)+r.y*d,n.z*(1-d)+r.z*d);l.rootNode.position=u}i++}}this.debugLog(`Updated radius to ${e}`)}getName(){return"Layer Four Ring"}getMinRadius(){return 120}getMaxRadius(){return 220}getDefaultRadius(){return 145.6}onRender(){this.debugLog("Initializing LayerFourRingModel"),this.cornerCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.sideCuts.forEach(e=>{e&&typeof e.onRender=="function"&&e.onRender()}),this.debugLog("LayerFourRingModel initialization complete")}dispose(){this.cornerCuts=[],this.cornerRotations=[],this.sideCuts=[],this.sideRotations=[],super.dispose()}}class ae extends N{constructor(e,t=new h(0,0,0),i={}){const s={debug:!1,singleCutRadius:21,rotationAngle:30,visibility:{ring:!0}};super(e,t,{...s,...i}),this.createModels()}createModels(){this.debugLog("Creating Ring Model with central CUT and outer rings");const{singleCutRadius:e,rotationAngle:t}=this.options,i=new b(this.scene,new h(0,0,0),{radius:e,rotationAngle:t,parent:this,debug:this.options.debug});this.centralCut=i,this.addChild(i);const s=new se(this.scene,new h(0,0,0),{singleCutRadius:e,cornerRotationAngle:t,parent:this,debug:this.options.debug});this.layerOneRing=s,this.addChild(s);const o=new oe(this.scene,new h(0,0,0),{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:t,parent:this,debug:this.options.debug});this.layerTwoRing=o,this.addChild(o);const n=new ne(this.scene,new h(0,0,0),{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:t,parent:this,debug:this.options.debug});this.layerThreeRing=n,this.addChild(n);const r=new re(this.scene,new h(0,0,0),{singleCutRadius:e,cornerRotationAngle:t,sideRotationAngle:t,parent:this,debug:this.options.debug});this.layerFourRing=r,this.addChild(r),this.debugLog("Ring Model creation complete")}getName(){return"Ring"}onRender(){this.debugLog("Initializing Ring Model"),this.centralCut&&typeof this.centralCut.onRender=="function"&&this.centralCut.onRender(),this.layerOneRing&&typeof this.layerOneRing.onRender=="function"&&this.layerOneRing.onRender(),this.layerTwoRing&&typeof this.layerTwoRing.onRender=="function"&&this.layerTwoRing.onRender(),this.layerThreeRing&&typeof this.layerThreeRing.onRender=="function"&&this.layerThreeRing.onRender(),this.layerFourRing&&typeof this.layerFourRing.onRender=="function"&&this.layerFourRing.onRender(),this.layerFiveRing&&typeof this.layerFiveRing.onRender=="function"&&this.layerFiveRing.onRender(),this.debugLog("Ring Model initialization complete")}updateRadiusSettings(e,t){this.options.singleCutRadius=t;const i=this.layerOneRing?this.layerOneRing.getDefaultRadius():36.4,s=this.layerTwoRing?this.layerTwoRing.getDefaultRadius():72.8,o=this.layerThreeRing?this.layerThreeRing.getDefaultRadius():109.2,n=this.layerFourRing?this.layerFourRing.getDefaultRadius():145.6,r=this.layerFiveRing?this.layerFiveRing.getDefaultRadius():182,a=e/r;if(this.layerOneRing){const l=this.layerOneRing.getRadius();l&&(l.value=i*a)}if(this.layerTwoRing){const l=this.layerTwoRing.getRadius();l&&(l.value=s*a)}if(this.layerThreeRing){const l=this.layerThreeRing.getRadius();l&&(l.value=o*a)}if(this.layerFourRing){const l=this.layerFourRing.getRadius();l&&(l.value=n*a)}if(this.layerFiveRing){const l=this.layerFiveRing.getRadius();l&&(l.value=e)}this.debugLog(`Updated radius settings: outerRadius=${e}, singleCutRadius=${t}, scaleFactor=${a}`)}}const m={ORBIT:"Orbit",FIRST_PERSON:"First Person",FLIGHT:"Flight"};class le{constructor(e,t,i={}){this.scene=e,this.canvas=t,this.options={initialPosition:new h(0,100,200),zoomScaling:5,minDistance:20,maxDistance:500,...i},this.currentMode=m.ORBIT,this.currentCamera=null,this.cameraMoveSpeed=1,this.cameraRotationSpeed=.005,this.minHeightAboveGround=2,this.collisionDistance=4,this.transitionDuration=1e3,this.isTransitioning=!1,this.keys={w:!1,a:!1,s:!1,d:!1,space:!1,shift:!1},this.maxPipeHeight=1500,this.showCollisionRays=!1,this.useDebugUI=!1,this.setupCameras(),this.setActiveCamera(this.currentMode),this.setupControls(),this.collisionRayHelpers=[]}setupCameras(){this.orbitCamera=new W("orbitCamera",-Math.PI/2,Math.PI/3,this.options.maxDistance/2,new h(0,0,0),this.scene),this.orbitCamera.lowerRadiusLimit=this.options.minDistance||10,this.orbitCamera.upperRadiusLimit=this.options.maxDistance||2e3,this.orbitCamera.wheelDeltaPercentage=this.options.zoomScaling?this.options.zoomScaling/500:.01,this.orbitCamera.panningSensibility=50,this.orbitCamera.checkCollisions=!1,this.orbitCamera.lowerBetaLimit=.1,this.orbitCamera.upperBetaLimit=Math.PI/2-.1,this.firstPersonCamera=new v("firstPersonCamera",this.options.initialPosition||new h(0,this.minHeightAboveGround,-50),this.scene),this.firstPersonCamera.fov=1.2,this.firstPersonCamera.minZ=.1,this.firstPersonCamera.checkCollisions=!0,this.firstPersonCamera.ellipsoid=new h(2,2,2),this.firstPersonCamera.applyGravity=!0,this.firstPersonCamera.keysUp=[],this.firstPersonCamera.keysDown=[],this.firstPersonCamera.keysLeft=[],this.firstPersonCamera.keysRight=[],this.flightCamera=new v("flightCamera",new h(0,100,-100),this.scene),this.flightCamera.fov=1.2,this.flightCamera.minZ=.1,this.flightCamera.checkCollisions=!0,this.flightCamera.ellipsoid=new h(2,2,2),this.flightCamera.applyGravity=!1,this.flightCamera.keysUp=[],this.flightCamera.keysDown=[],this.flightCamera.keysLeft=[],this.flightCamera.keysRight=[]}setupControls(){this.scene.onKeyboardObservable.add(e=>{const t=e.event;if(e.type===k.KEYDOWN)switch(t.code){case"KeyW":this.keys.w=!0;break;case"KeyA":this.keys.a=!0;break;case"KeyS":this.keys.s=!0;break;case"KeyD":this.keys.d=!0;break;case"Space":this.keys.space=!0;break;case"ShiftLeft":case"ShiftRight":this.keys.shift=!0;break;case"KeyM":this.toggleCameraMode();break;case"KeyH":document.body.classList.toggle("show-controls");break}else if(e.type===k.KEYUP)switch(t.code){case"KeyW":this.keys.w=!1;break;case"KeyA":this.keys.a=!1;break;case"KeyS":this.keys.s=!1;break;case"KeyD":this.keys.d=!1;break;case"Space":this.keys.space=!1;break;case"ShiftLeft":case"ShiftRight":this.keys.shift=!1;break}}),this.canvas.addEventListener("click",()=>{(this.currentMode===m.FIRST_PERSON||this.currentMode===m.FLIGHT)&&(this.canvas.requestPointerLock=this.canvas.requestPointerLock||this.canvas.msRequestPointerLock||this.canvas.mozRequestPointerLock||this.canvas.webkitRequestPointerLock,this.canvas.requestPointerLock&&this.canvas.requestPointerLock())}),this.useDebugUI&&this.scene.registerBeforeRender(()=>this.updateCameraInfo()),this.scene.registerBeforeRender(()=>this.updateCameraMovement())}updateCameraInfo(){if(!document.getElementById("positionText"))return;const t=this.currentCamera.position,i=document.getElementById("positionText");i&&(i.textContent=`${t.x.toFixed(1)}, ${t.y.toFixed(1)}, ${t.z.toFixed(1)}`);const s=t.y,o=document.getElementById("heightText");o&&(o.textContent=`${s.toFixed(1)}m`);const n=s/this.maxPipeHeight*100,r=document.getElementById("heightPercentText");r&&(r.textContent=`${n.toFixed(1)}%`);const a=document.getElementById("cameraModeText");a&&(a.textContent=this.currentMode)}updateCameraMovement(){if(this.currentMode===m.ORBIT||!this.currentCamera)return;const e=this.currentCamera,t=e.position.clone();let i=h.Zero();if(this.keys.w){const s=this.currentCamera.getDirection(h.Forward());i.addInPlace(s)}if(this.keys.s){const s=this.currentCamera.getDirection(h.Backward());i.addInPlace(s)}if(this.keys.a){const s=this.currentCamera.getDirection(h.Left());i.addInPlace(s)}if(this.keys.d){const s=this.currentCamera.getDirection(h.Right());i.addInPlace(s)}if(this.keys.space&&i.addInPlace(h.Up()),this.keys.shift&&i.addInPlace(h.Down()),i.length()>0){i.normalize(),i.scaleInPlace(this.cameraMoveSpeed);const s=t.add(i);s.y<this.minHeightAboveGround&&(s.y=this.minHeightAboveGround),(this.options.pipes&&this.options.pipes.length>0?this.checkCollisions(t,s):!1)||(e.position=s)}}checkCollisions(e,t){if(!this.options.pipes||this.options.pipes.length===0)return!1;const i=t.subtract(e),s=i.length(),o=new G(e,i.normalize(),s),n=this.options.pipes.some(r=>!r||!r.isEnabled()||!r.isPickable?!1:o.intersectsMesh(r).hit);return this.showCollisionRays&&this.visualizeCollisionRay(o,n),n}visualizeCollisionRay(e,t){this.collisionRayHelpers.forEach(o=>o.dispose()),this.collisionRayHelpers=[];const i=new I.CreateLines("rayHelper",{points:[e.origin,e.origin.add(e.direction.scale(e.length))],updatable:!1},this.scene),s=new S("rayMaterial",this.scene);s.emissiveColor=t?y.Red():y.Green(),i.material=s,this.collisionRayHelpers.push(i)}setActiveCamera(e){let t;switch(e){case m.ORBIT:t=this.orbitCamera;break;case m.FIRST_PERSON:t=this.firstPersonCamera;break;case m.FLIGHT:t=this.flightCamera;break;default:t=this.orbitCamera;break}this.currentCamera=t,this.scene.activeCamera=t,t.attachControl(this.canvas,!0)}toggleCameraMode(){if(this.isTransitioning)return;let e;switch(this.currentMode){case m.ORBIT:e=m.FIRST_PERSON;break;case m.FIRST_PERSON:e=m.FLIGHT;break;case m.FLIGHT:e=m.ORBIT;break;default:e=m.ORBIT;break}this.transitionToMode(e)}transitionToMode(e){this.isTransitioning=!0;const t=this.currentCamera;t.detachControl(this.canvas);let i;switch(e){case m.ORBIT:i=this.orbitCamera,this.orbitCamera.setTarget(new h(0,0,0));break;case m.FIRST_PERSON:if(i=this.firstPersonCamera,this.currentMode===m.ORBIT){const u=this.orbitCamera.target.subtract(this.orbitCamera.position).normalize(),f=this.orbitCamera.position.add(u.scale(50));f.y=Math.max(f.y,this.minHeightAboveGround),this.firstPersonCamera.position=f,this.firstPersonCamera.setTarget(f.add(u))}break;case m.FLIGHT:if(i=this.flightCamera,this.currentMode===m.FIRST_PERSON){const u=this.firstPersonCamera.getDirection(h.Forward()),f=this.firstPersonCamera.position.clone();f.y+=50,this.flightCamera.position=f,this.flightCamera.setTarget(f.add(u))}break}let s=performance.now();const o=t.position.clone(),n=t.rotationQuaternion?t.rotationQuaternion.clone():$.RotationYawPitchRoll(t.rotation.y,t.rotation.x,t.rotation.z),r=i.position.clone(),a=i.rotationQuaternion?i.rotationQuaternion.clone():$.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z),l=t.clone("transitionCamera");l.position=o,l.rotationQuaternion=n,this.scene.activeCamera=l;const d=()=>{const f=performance.now()-s,p=Math.min(f/this.transitionDuration,1),g=(w=>w<.5?2*w*w:-1+(4-2*w)*w)(p),M=h.Lerp(o,r,g),x=$.Slerp(n,a,g);l.position=M,l.rotationQuaternion=x,p<1?requestAnimationFrame(d):(this.currentMode=e,this.setActiveCamera(e),this.isTransitioning=!1,l.dispose())};d()}getCurrentCameraName(){return this.currentMode}}class de{constructor(e,t={}){this.cameraController=e,this.options=t,this.models=t.models||[],this.createContainers(),this.createControlsInfoPanel(),this.initUI(),this.models&&this.models.length>0&&this.createModelControls(),t.showDebugInfo&&this.createDebugInfoView(),t.showRadiusControl&&this.createRadiusControl()}initUI(){this.createCameraToggleButton(),!this.options.showOnlyDebugToggle&&(this.options.sceneEditor&&(this.sceneEditor=this.options.sceneEditor),document.addEventListener("keydown",e=>{e.code==="KeyH"&&document.body.classList.toggle("show-controls")}))}createContainers(){if(document.getElementById("toggleButtons"))this.toggleButtonsContainer=document.getElementById("toggleButtons");else{const e=document.createElement("div");e.id="toggleButtons",e.style.position="absolute",e.style.bottom="20px",e.style.right="20px",e.style.display="flex",e.style.flexDirection="row",e.style.gap="10px",e.style.zIndex="100",document.body.appendChild(e),this.toggleButtonsContainer=e}if(!this.options.showOnlyDebugToggle)if(document.getElementById("controlPanels"))this.controlPanelsContainer=document.getElementById("controlPanels");else{const e=document.createElement("div");e.id="controlPanels",e.style.position="absolute",e.style.top="50px",e.style.left="10px",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",e.style.zIndex="100",document.body.appendChild(e),this.controlPanelsContainer=e}}createModelControls(){if(this.options.showOnlyDebugToggle)return;const{DebugInfoView:e}=this.options.controlClasses||{};e&&this.options.showDebugInfo&&(this.debugInfoView=new e(this.models,{app:this.options.app}))}createDebugInfoView(){const{DebugInfoView:e}=this.options.controlClasses||{};e&&(this.debugInfoView=new e({isVisible:!0,cameraController:this.cameraController,app:this.options.app}))}createRadiusControl(){const{RadiusControl:e}=this.options.controlClasses||{};e&&(this.radiusControl=new e(this.models,{isVisible:!0,app:this.options.app,includeChildren:!0}))}createControlsInfoPanel(){if(this.options.showOnlyDebugToggle)return;const e=this.controlPanelsContainer||document.getElementById("controlPanels");if(!e){console.error("Control panels container not found");return}this.controlsInfo=document.createElement("div"),this.controlsInfo.id="controlsInfo",this.controlsInfo.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.controlsInfo.style.padding="10px",this.controlsInfo.style.borderRadius="5px",this.controlsInfo.style.color="#ffffff",this.controlsInfo.style.display="none",this.controlsInfo.style.zIndex="100",this.controlsInfo.style.position="absolute",this.controlsInfo.style.top="10px",this.controlsInfo.style.left="10px",this.controlsInfo.style.maxWidth="400px",this.controlsInfo.innerHTML=`
            <h3 style="margin-top: 0; margin-bottom: 10px;">Controls</h3>
            <p><strong>Show/Hide Controls:</strong> Press H</p>
            <p><strong>Camera Mode:</strong> Press Tab</p>
            <p><strong>Movement (First Person/Flight):</strong> WASD</p>
            <p><strong>Up/Down (Flight):</strong> Space/Shift</p>
            <p><strong>Look Around:</strong> Click and Drag</p>
            <p><strong>Zoom (Orbit):</strong> Mouse Wheel</p>
            <p><strong>Scene Editor:</strong> Press E</p>
        `,e.appendChild(this.controlsInfo)}createCameraToggleButton(){try{const e=this.toggleButtonsContainer||document.getElementById("toggleButtons");if(!e){console.error("Toggle buttons container not found");return}const t=document.createElement("button");t.textContent="Camera",t.className="control-button",t.style.backgroundColor="#333",t.style.color="#fff",t.style.border="none",t.style.padding="8px 16px",t.style.borderRadius="4px",t.style.cursor="pointer",t.style.fontWeight="bold",t.style.fontSize="14px",t.style.width="120px",t.style.textAlign="center",t.style.transition="background-color 0.3s",t.style.boxShadow="0 2px 4px rgba(0,0,0,0.3)",t.addEventListener("mouseenter",()=>{t.style.backgroundColor="#444"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="#333"}),t.addEventListener("click",()=>{this.cameraController&&(this.cameraController.toggleCameraMode(),t.textContent=`Camera: ${this.cameraController.getCurrentCameraName()}`)}),this.cameraController&&(t.textContent=`Camera: ${this.cameraController.getCurrentCameraName()}`),e.appendChild(t),this.cameraButton=t}catch(e){console.error("Error creating camera toggle button:",e)}}update(){this.cameraButton&&this.cameraController&&(this.cameraButton.textContent=`Camera: ${this.cameraController.getCurrentCameraName()}`),this.debugInfoView&&this.debugInfoView.update(),this.radiusControl&&this.radiusControl.update()}}class he{constructor(e,t){this.scene=e,this.sceneObjects={},Array.isArray(t)?t.forEach(i=>{if(i){const s=i.getName?i.getName():i.constructor?i.constructor.name:"Unknown Model";this.sceneObjects[s]={model:i,children:{}},i.getChildren&&typeof i.getChildren=="function"&&i.getChildren().forEach(n=>{if(n){const r=n.getName?n.getName():n.constructor?n.constructor.name:"Unknown Child";this.sceneObjects[s].children[r]={model:n}}})}}):this.sceneObjects=t||{},this.isVisible=!1,this.lastUpdateTime=0,this.updateInterval=500,this.createUI(),this.checkboxElements={},this.objectIdMap={},this.nameCountMap={},this.isUpdating=!1,this.renderSceneObjects(),this.setupKeyboardShortcut()}createUI(){this.container=document.createElement("div"),this.container.id="sceneEditor",this.container.style.position="absolute",this.container.style.top="50px",this.container.style.right="10px",this.container.style.width="300px",this.container.style.backgroundColor="rgba(0, 0, 0, 0.7)",this.container.style.color="white",this.container.style.padding="10px",this.container.style.borderRadius="5px",this.container.style.maxHeight="80vh",this.container.style.overflowY="auto",this.container.style.display="none",this.container.style.zIndex="100",this.container.style.fontFamily="Arial, sans-serif";const e=document.createElement("style");e.textContent=`
            .collapse-btn {
                cursor: pointer;
                user-select: none;
                margin-right: 5px;
                display: inline-block;
                width: 16px;
                height: 16px;
                text-align: center;
                line-height: 14px;
                border: 1px solid #555;
                border-radius: 2px;
                background-color: #333;
            }
            .collapse-btn:hover {
                background-color: #444;
            }
            .collapsed {
                display: none !important;
            }
            .object-label {
                cursor: pointer;
            }
            .object-row {
                display: flex;
                align-items: center;
            }
        `,document.head.appendChild(e);const t=document.createElement("div");t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center",t.style.marginBottom="10px";const i=document.createElement("h3");i.textContent="Scene Editor",i.style.margin="0";const s=document.createElement("button");s.textContent="X",s.style.background="none",s.style.border="none",s.style.color="white",s.style.cursor="pointer",s.style.fontSize="16px",s.addEventListener("click",()=>this.toggle());const o=document.createElement("div");o.style.display="flex",o.style.gap="10px";const n=document.createElement("button");n.textContent="Expand All",n.style.fontSize="11px",n.style.padding="2px 5px",n.style.backgroundColor="#333",n.style.color="white",n.style.border="1px solid #555",n.style.borderRadius="3px",n.style.cursor="pointer",n.addEventListener("click",()=>this.expandAll());const r=document.createElement("button");r.textContent="Collapse All",r.style.fontSize="11px",r.style.padding="2px 5px",r.style.backgroundColor="#333",r.style.color="white",r.style.border="1px solid #555",r.style.borderRadius="3px",r.style.cursor="pointer",r.addEventListener("click",()=>this.collapseAll()),o.appendChild(n),o.appendChild(r),t.appendChild(i),t.appendChild(o);const a=document.createElement("div");a.appendChild(s);const l=document.createElement("div");l.style.display="flex",l.style.justifyContent="space-between",l.style.alignItems="center",l.style.marginBottom="10px",l.appendChild(t),l.appendChild(a),this.objectListContainer=document.createElement("div"),this.objectListContainer.id="objectList",this.container.appendChild(l),this.container.appendChild(this.objectListContainer),document.body.appendChild(this.container),this.toggleButton=document.createElement("button"),this.toggleButton.id="sceneEditorToggle",this.toggleButton.textContent="Scene Editor",this.toggleButton.style.position="absolute",this.toggleButton.style.top="10px",this.toggleButton.style.right="10px",this.toggleButton.style.padding="5px 10px",this.toggleButton.style.borderRadius="5px",this.toggleButton.style.cursor="pointer",this.toggleButton.addEventListener("click",()=>this.toggle()),document.body.appendChild(this.toggleButton)}expandAll(){this.container.querySelectorAll(".object-children").forEach(t=>{t.classList.remove("collapsed");const s=t.parentElement.querySelector(".collapse-btn");s&&(s.textContent="-")})}collapseAll(){this.container.querySelectorAll(".object-children").forEach(t=>{t.classList.add("collapsed");const s=t.parentElement.querySelector(".collapse-btn");s&&(s.textContent="+")})}toggle(){if(this.isVisible=!this.isVisible,this.container.style.display=this.isVisible?"block":"none",this.isVisible){this.renderSceneObjects(),this.updateCheckboxStates();for(const[e,t]of Object.entries(this.sceneObjects))t.isVisible===!1&&this.checkboxElements[e]&&(this.checkboxElements[e].element.checked=!1,this.toggleObjectVisibility(e,t,!1));this.collapseAll()}}renderSceneObjects(){this.objectListContainer.innerHTML="",this.nameCountMap={};const e=document.createElement("div");e.className="scene-objects-tree";for(const[t,i]of Object.entries(this.sceneObjects)){const s=this.createObjectListItem(t,i);e.appendChild(s),i.isVisible===!1&&this.checkboxElements[t]&&(this.checkboxElements[t].element.checked=!1,this.toggleObjectVisibility(t,i,!1))}this.objectListContainer.appendChild(e)}getDisplayName(e,t,i=""){let s=e;if(t&&typeof t.getName=="function"?s=t.getName():t&&t.model&&typeof t.model.getName=="function"&&(s=t.model.getName()),!i)return s;const o=`${i}/${s}`;this.nameCountMap[o]||(this.nameCountMap[o]={count:0,instances:[]});const n=t.id||t.model&&t.model.id||t.uniqueId||Math.random().toString(36).substr(2,9);this.nameCountMap[o].instances.includes(n)||(this.nameCountMap[o].count++,this.nameCountMap[o].instances.push(n));const a=this.nameCountMap[o].instances.indexOf(n)+1;return this.nameCountMap[o].count>1&&(s=`${s} #${a}`),s}createObjectListItem(e,t,i=null,s=""){let o=this.getDisplayName(e,t,s);const n=s?`${s}/${e}`:e,r=document.createElement("div");r.className="scene-object-item",r.style.marginLeft="15px",r.style.marginBottom="8px";const a=document.createElement("div");a.className="object-row";const l=this.hasChildren(t);if(l){const g=document.createElement("span");g.className="collapse-btn",g.textContent="-",g.title="Collapse/Expand",g.onclick=M=>{M.stopPropagation();const x=r.querySelector(":scope > .object-children");if(x){const w=x.classList.contains("collapsed");x.classList.toggle("collapsed"),g.textContent=w?"-":"+"}},a.appendChild(g)}else{const g=document.createElement("span");g.style.display="inline-block",g.style.width="16px",g.style.marginRight="5px",a.appendChild(g)}const d=document.createElement("input");d.type="checkbox",d.style.marginRight="5px",d.checked=this.getObjectVisibility(t),typeof d.checked!="boolean"&&(d.checked=!0);const u=t.id||t.model&&t.model.id||null;d.setAttribute("data-object-path",n),u&&(d.setAttribute("data-object-id",u),this.objectIdMap[u]=t),d.addEventListener("change",()=>{const g=d.checked,M=d.getAttribute("data-object-path"),x=d.getAttribute("data-object-id");this.checkboxElements[M]={element:d,object:t,objectId:x},this.toggleObjectVisibility(M,t,g,x),this.updateNestedCheckboxes(M,g)}),this.checkboxElements[n]={element:d,object:t,objectId:u},a.appendChild(d);const f=document.createElement("span");f.style.display="flex",f.style.alignItems="center",f.style.flexGrow="1";const p=document.createElement("span");p.className="object-label",p.textContent=o,p.style.flexGrow="1",p.style.overflow="hidden",p.style.textOverflow="ellipsis",p.style.whiteSpace="nowrap",p.style.maxWidth="200px",this.isElementPermanentlyHidden(n,t)&&(p.style.color="#999",p.style.textDecoration="line-through",p.title="This element is permanently hidden"),u&&(p.title=`ID: ${u}
${p.title||""}`);const C=document.createElement("button");if(C.textContent="i",C.style.marginLeft="5px",C.style.width="16px",C.style.height="16px",C.style.background="#333",C.style.color="#fff",C.style.border="1px solid #555",C.style.borderRadius="50%",C.style.cursor="pointer",C.style.fontSize="10px",C.style.lineHeight="1",C.style.padding="0",C.title="Show info",C.addEventListener("click",g=>{g.stopPropagation(),typeof this.logModelInfo=="function"?(console.group(`Info for "${o}"`),this.logModelInfo(t),console.groupEnd()):(console.group(`Info for "${o}"`),console.log("Object:",t),t&&t.constructor&&console.log("Type:",t.constructor.name),u&&console.log("ID:",u),console.groupEnd())}),f.appendChild(p),f.appendChild(C),a.appendChild(f),r.appendChild(a),l){const g=document.createElement("div");g.className="object-children",g.style.marginLeft="15px",(t.pipes||t.panels)&&this.addModelChildren(g,t,n),t.model&&t.model.singleCuts&&this.addCompositeModelChildren(g,t,n),t.children&&Object.keys(t.children).length>0&&this.addChildrenObjects(g,t.children,n),r.appendChild(g)}return r}isElementPermanentlyHidden(e,t){return t&&t.isPermanentlyHidden===!0?!0:t&&typeof t.isPermanentlyHidden=="function"?t.isPermanentlyHidden():t&&t.model&&typeof t.model.isPermanentlyHidden=="function"?t.model.isPermanentlyHidden():!1}findParentObject(e){if(!e.includes("/"))return null;const t=e.substring(0,e.lastIndexOf("/"));return this.sceneObjects[t]||Object.values(this.sceneObjects).find(i=>i.model&&i.model.singleCuts&&i.model.singleCuts.length>0)}addModelChildren(e,t,i){t.pipes&&t.pipes.length>0&&(t.pipes.map(o=>o&&typeof o.getName=="function"?o.getName():"Pipe").forEach(o=>{}),t.pipes.forEach((o,n)=>{const r=`Pipe #${n+1}`,a=this.createObjectListItem(r,o,t,i);e.appendChild(a)})),t.panels&&t.panels.length>0&&(t.panels.map(o=>o&&typeof o.getName=="function"?o.getName():"Panel").forEach(o=>{}),t.panels.forEach((o,n)=>{const r=`Panel #${n+1}`,a=this.createObjectListItem(r,o,t,i);e.appendChild(a)}))}addCompositeModelChildren(e,t,i){if(!t.model||!t.model.singleCuts||!t.model.singleCuts.length)return;const s=t.model.singleCuts;s.forEach(o=>{o&&typeof o.getName=="function"&&o.getName()}),s.forEach((o,n)=>{const r=`Single CUT #${n+1}`,a=this.createObjectListItem(r,o,t,i);e.appendChild(a)})}addChildrenObjects(e,t,i){Object.entries(t).forEach(([s,o])=>{o&&typeof o.getName=="function"?o.getName():o&&o.model&&typeof o.model.getName=="function"&&o.model.getName()}),Object.entries(t).forEach(([s,o])=>{const n=this.createObjectListItem(s,o,null,i);e.appendChild(n)})}hasChildren(e){return e.pipes&&e.pipes.length>0||e.panels&&e.panels.length>0||e.children&&Object.keys(e.children).length>0||e.model&&e.model.singleCuts&&e.model.singleCuts.length>0||e.model&&e.model.childModels&&e.model.childModels.length>0}getObjectVisibility(e){return!e||e.isVisible===!1?!1:typeof e.isVisible=="function"?e.isVisible():e.model&&typeof e.model.isVisible=="function"?e.model.isVisible():e.rootNode&&typeof e.rootNode.isEnabled=="function"?e.rootNode.isEnabled():e.mesh&&typeof e.mesh.isVisible=="boolean"?e.mesh.isVisible:e.pipeMesh&&typeof e.pipeMesh.isVisible=="boolean"?e.pipeMesh.isVisible:e.panelMesh&&typeof e.panelMesh.isVisible=="boolean"?e.panelMesh.isVisible:!0}toggleObjectVisibility(e,t,i,s=null){console.log(`[SceneEditor] Toggling visibility of "${e}" ${s?`(ID: ${s})`:""} to ${i?"visible":"hidden"}`),s&&this.objectIdMap[s]&&(t=this.objectIdMap[s],console.log(`[SceneEditor] Using object from ID map for ${s}`)),this.setObjectVisibility(t,i,e),this.checkboxElements[e]&&(this.checkboxElements[e].element.checked=i)}updateNestedCheckboxes(e,t){var o,n;console.log(`Updating nested checkboxes for ${e} to ${t}`);const i=(o=this.checkboxElements[e])==null?void 0:o.object,s=(n=this.checkboxElements[e])==null?void 0:n.objectId;if(i){i.model&&(i.model.childModels&&i.model.childModels.length>0||i.model.children&&Object.keys(i.model.children).length>0);for(const[r,a]of Object.entries(this.checkboxElements))if(!a.isPermanentlyHidden&&(r.startsWith(e+"/")&&(console.log(`Setting child checkbox for ${r} to ${t}`),a.element.checked=t,this.toggleObjectVisibility(r,a.object,t,a.objectId)),s&&i.childModels)){const l=a.object;l&&i.childModels.some(u=>u.id===l.id||l.model&&u.id===l.model.id)&&(console.log(`Setting child checkbox for ${r} (matched by ID) to ${t}`),a.element.checked=t,this.toggleObjectVisibility(r,a.object,t,a.objectId))}}}updateCheckboxStates(){if(!this.isUpdating){this.isUpdating=!0;try{for(const[e,t]of Object.entries(this.checkboxElements))if(t.element&&t.object){const i=t.objectId&&this.objectIdMap[t.objectId]?this.objectIdMap[t.objectId]:t.object,s=this.getObjectVisibility(i);!this.desiredVisibilityState||this.desiredVisibilityState[e]===void 0?t.element.checked=s:t.element.checked=this.desiredVisibilityState[e]}}finally{this.isUpdating=!1}}}update(e){if(!this.isVisible)return;const t=e||Date.now();t-this.lastUpdateTime>this.updateInterval&&(this.updateCheckboxStates(),this.lastUpdateTime=t)}setupKeyboardShortcut(){window.addEventListener("keydown",e=>{e.code==="KeyE"&&this.toggle()})}setObjectVisibility(e,t,i=""){if(!e){console.log(`[SceneEditor] Object is null or undefined for path: ${i}`);return}const s=e.id||e.model&&e.model.id;if(i&&this.isElementPermanentlyHidden(i,e)){console.log(`[SceneEditor] Skipping permanently hidden element: ${i}${s?` (ID: ${s})`:""}`);return}if(console.log(`[SceneEditor] Setting visibility for ${i}${s?` (ID: ${s})`:""} to ${t?"visible":"hidden"}`),e.model&&typeof e.model.setVisible=="function"){console.log(`[SceneEditor] Setting visibility via object.model.setVisible for ${i}`),e.model.setVisible(t),typeof e.model.isVisible=="function"&&console.log(`[SceneEditor] After setting, object.model.isVisible(): ${e.model.isVisible()}`);return}if(typeof e.setVisible=="function"?(console.log(`[SceneEditor] Using setVisible method for ${e.constructor?e.constructor.name:"object"}`,t),e.setVisible(t),typeof e.isVisible=="function"&&console.log(`[SceneEditor] After setting, object.isVisible(): ${e.isVisible()}`)):e.rootNode&&e.rootNode.setEnabled?(console.log(`[SceneEditor] Setting root node enabled state to ${t}`),e.rootNode.setEnabled(t),e.rootNode.isEnabled&&console.log(`[SceneEditor] After setting, rootNode.isEnabled(): ${e.rootNode.isEnabled()}`)):e.mesh&&e.mesh.isVisible!==void 0?(console.log(`[SceneEditor] Setting mesh visibility to ${t}`),e.mesh.isVisible=t,console.log(`[SceneEditor] After setting, mesh.isVisible: ${e.mesh.isVisible}`)):e.pipeMesh&&e.pipeMesh.isVisible!==void 0?(console.log(`[SceneEditor] Setting pipe mesh visibility to ${t}`),e.pipeMesh.isVisible=t,console.log(`[SceneEditor] After setting, pipeMesh.isVisible: ${e.pipeMesh.isVisible}`)):e.panelMesh&&e.panelMesh.isVisible!==void 0?(console.log(`[SceneEditor] Setting panel mesh visibility to ${t}`),e.panelMesh.isVisible=t,e.rootNode&&(console.log(`[SceneEditor] Setting panel root node enabled state to ${t}`),e.rootNode.setEnabled(t)),e.panelMesh.refreshBoundingInfo(),console.log(`[SceneEditor] After setting, panelMesh.isVisible: ${e.panelMesh.isVisible}`)):(console.log(`[SceneEditor] No visibility method found for object at path: ${i}`),console.log("[SceneEditor] Object:",e)),console.log(`[SceneEditor] Processing children of ${i}${s?` (ID: ${s})`:""}`),e.childModels&&Array.isArray(e.childModels)&&(console.log(`[SceneEditor] Processing ${e.childModels.length} childModels for ${i}`),e.childModels.forEach((o,n)=>{const r=o.id?`${i}/ChildModel_${o.id.substring(0,8)}`:`${i}/ChildModel #${n+1}`;this.setObjectVisibility(o,t,r)})),e.model&&e.model.singleCuts&&(console.log(`[SceneEditor] Processing ${e.model.singleCuts.length} singleCuts for ${i}`),e.model.singleCuts.forEach((o,n)=>{const r=i?`${i}/Single CUT #${n+1}`:`Single CUT #${n+1}`;this.setObjectVisibility(o,t,r)})),e.childModels&&Array.isArray(e.childModels)&&(console.log(`[SceneEditor] Processing ${e.childModels.length} childModels for ${i}`),e.childModels.forEach((o,n)=>{const r=i?`${i}/ChildModel #${n+1}`:`ChildModel #${n+1}`;this.setObjectVisibility(o,t,r)})),e.pipes&&Array.isArray(e.pipes)&&(console.log(`[SceneEditor] Processing ${e.pipes.length} pipes for ${i}`),e.pipes.forEach((o,n)=>{const r=i?`${i}/Pipe #${n+1}`:`Pipe #${n+1}`;this.setObjectVisibility(o,t,r)})),e.panels&&Array.isArray(e.panels)&&(console.log(`[SceneEditor] Processing ${e.panels.length} panels for ${i}`),e.panels.forEach((o,n)=>{const r=i?`${i}/Panel #${n+1}`:`Panel #${n+1}`;this.setObjectVisibility(o,t,r)})),e.children&&typeof e.children=="object"){const o=Object.keys(e.children).length;console.log(`[SceneEditor] Processing ${o} generic children for ${i}`),Object.entries(e.children).forEach(([n,r])=>{const a=i?`${i}/${n}`:n;this.setObjectVisibility(r,t,a)})}}}class ce{constructor(e={}){const t={isVisible:!0,maxLogEntries:50,textColor:"#ffffff",backgroundColor:"rgba(0, 0, 0, 0.7)",position:"top",cameraController:null};this.options={...t,...e},this.cameraController=this.options.cameraController,this.app=e.app||null,this.logs=[],this.createPanel(),this.createHTMLToggleButton(),console.log("DebugInfoView initialized - simple version")}createPanel(){try{if(console.log("Creating DebugInfoView panel"),this.controlPanels=document.getElementById("controlPanels"),!this.controlPanels){console.error("Control panels container not found");return}this.panel=document.createElement("div"),this.panel.id="debugInfoPanel",this.panel.style.backgroundColor=this.options.backgroundColor,this.panel.style.padding="10px",this.panel.style.borderRadius="5px",this.panel.style.color=this.options.textColor,this.panel.style.display=this.options.isVisible?"block":"none",this.panel.style.pointerEvents="auto",this.panel.style.maxWidth="400px",this.panel.style.maxHeight="300px",this.panel.style.overflowY="auto",this.panel.style.order="-1",this.updateCameraInfo(),this.controlPanels.firstChild?this.controlPanels.insertBefore(this.panel,this.controlPanels.firstChild):this.controlPanels.appendChild(this.panel),console.log("DebugInfoView panel created successfully")}catch(e){console.error("Error creating DebugInfoView panel:",e)}}updateCameraInfo(){if(!this.panel||!this.cameraController)return;this.panel.innerHTML="";const e=document.createElement("div");e.style.marginBottom="10px",e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center";const t=document.createElement("h3");t.textContent="Camera Debug Info",t.style.margin="0",t.style.fontSize="16px",e.appendChild(t),this.panel.appendChild(e);try{const i=document.createElement("div");i.style.backgroundColor="rgba(0, 0, 0, 0.3)",i.style.padding="10px",i.style.borderRadius="4px",i.style.marginBottom="10px";const s=this.cameraController.currentCamera,o=this.cameraController.currentMode,n=s.position,r=n.y,a=r/this.cameraController.maxPipeHeight*100;i.innerHTML=`
                <div style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">
                    ${o}
                </div>
                <div style="margin-bottom: 5px;">
                    Position: X: ${n.x.toFixed(1)}, Y: ${n.y.toFixed(1)}, Z: ${n.z.toFixed(1)}
                </div>
                <div>
                    Height: ${r.toFixed(1)}m (${a.toFixed(1)}%)
                </div>
            `,this.panel.appendChild(i)}catch(i){const s=document.createElement("div");s.style.color="#ff5555",s.textContent=`Error getting camera info: ${i.message}`,this.panel.appendChild(s)}}createHTMLToggleButton(){try{console.log("Creating debug info toggle button");let e=document.getElementById("toggleButtons");e||(e=document.getElementById("controlButtons")),e||(e=document.querySelector(".control-buttons-container")),e||(console.error("Control buttons container not found, creating new one"),e=document.createElement("div"),e.id="toggleButtons",e.style.position="absolute",e.style.bottom="20px",e.style.right="20px",e.style.display="flex",e.style.flexDirection="row",e.style.gap="10px",e.style.zIndex="100",document.body.appendChild(e));const t=document.createElement("button");t.id="debugInfoToggle",t.textContent="Debug",t.className="control-button",t.style.backgroundColor=this.options.isVisible?"#4CAF50":"#444444",t.style.color="#fff",t.style.border="none",t.style.padding="8px 16px",t.style.borderRadius="4px",t.style.cursor="pointer",t.style.fontWeight="bold",t.style.width="120px",t.style.textAlign="center",t.style.transition="background-color 0.3s",t.style.boxShadow="0 2px 4px rgba(0,0,0,0.3)",t.addEventListener("mouseover",()=>{t.style.backgroundColor=this.options.isVisible?"#45a049":"#555555"}),t.addEventListener("mouseout",()=>{t.style.backgroundColor=this.options.isVisible?"#4CAF50":"#444444"}),t.addEventListener("click",()=>{this.toggleVisible()}),e.appendChild(t),this.toggleButton=t,console.log("Debug info toggle button created successfully")}catch(e){console.error("Error creating debug info toggle button:",e)}}toggleVisible(){this.options.isVisible=!this.options.isVisible,this.toggleButton&&(this.toggleButton.style.backgroundColor=this.options.isVisible?"#4CAF50":"#444444"),this.panel&&(this.panel.style.display=this.options.isVisible?"block":"none"),console.log(`Debug info visibility toggled: ${this.options.isVisible}`)}update(){this.options.isVisible&&this.panel&&this.updateCameraInfo()}dispose(){this.toggleButton&&this.toggleButton.parentNode&&this.toggleButton.parentNode.removeChild(this.toggleButton),this.panel&&this.panel.parentNode&&this.panel.parentNode.removeChild(this.panel)}}class ue{constructor(e=[],t={}){const i={isVisible:!0,textColor:"#ffffff",backgroundColor:"rgba(0, 0, 0, 0.7)",position:"top",sliderWidth:"200px",inputWidth:"60px",includeChildren:!0};this.options={...i,...t},this.models=e,this.radiusModels=[],this.findRadiusModels(),this.createPanel(),this.createHTMLToggleButton(),console.log("RadiusControl initialized with",this.radiusModels.length,"radius-controllable models")}findRadiusModels(){this.radiusModels=[],Array.isArray(this.models)&&this.models.forEach(e=>{if(this.addModelIfHasRadius(e),this.options.includeChildren&&e&&typeof e.getChildren=="function")try{const t=e.getChildren();Array.isArray(t)&&t.forEach(i=>{this.addModelIfHasRadius(i)})}catch(t){console.error("Error getting children for model:",t)}}),console.log("Found",this.radiusModels.length,"models with radius controls")}addModelIfHasRadius(e){if(e&&typeof e.getRadius=="function")try{const t=e.getRadius();t&&typeof t.value<"u"&&this.radiusModels.push({model:e,name:e.getName?e.getName():e.constructor.name,radius:t})}catch(t){console.error("Error checking radius for model:",t)}}createPanel(){try{if(console.log("Creating RadiusControl panel"),this.controlPanels=document.getElementById("controlPanels"),!this.controlPanels){console.error("Control panels container not found");return}this.panel=document.createElement("div"),this.panel.id="radiusControlPanel",this.panel.style.backgroundColor=this.options.backgroundColor,this.panel.style.padding="10px",this.panel.style.borderRadius="5px",this.panel.style.color=this.options.textColor,this.panel.style.display=this.options.isVisible?"block":"none",this.panel.style.pointerEvents="auto",this.panel.style.maxWidth="400px",this.panel.style.maxHeight="400px",this.panel.style.overflowY="auto";const e=document.createElement("div");e.style.marginBottom="10px",e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center";const t=document.createElement("h3");t.textContent="Radius Control",t.style.margin="0",e.appendChild(t),this.panel.appendChild(e),this.radiusModels.length>1&&this.createModelSelector(),this.createRadiusControls(),this.controlPanels.appendChild(this.panel),console.log("RadiusControl panel created successfully")}catch(e){console.error("Error creating RadiusControl panel:",e)}}createModelSelector(){const e=document.createElement("div");e.style.marginBottom="15px";const t=document.createElement("label");t.textContent="Select Model: ",t.style.marginRight="10px",e.appendChild(t),this.modelSelector=document.createElement("select"),this.modelSelector.style.padding="5px",this.modelSelector.style.backgroundColor="#333",this.modelSelector.style.color="#fff",this.modelSelector.style.border="1px solid #555",this.modelSelector.style.borderRadius="4px",this.radiusModels.forEach((i,s)=>{const o=document.createElement("option");o.value=s,o.textContent=i.name,this.modelSelector.appendChild(o)}),this.modelSelector.addEventListener("change",()=>{this.updateRadiusControls()}),e.appendChild(this.modelSelector),this.panel.appendChild(e)}createRadiusControls(){const e=document.createElement("div");if(e.id="radiusControlsContainer",this.radiusModels.length>0){this.radiusValueContainer=document.createElement("div"),this.radiusValueContainer.style.marginBottom="10px";const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.marginBottom="15px";const i=document.createElement("label");i.textContent="Radius: ",i.style.marginRight="10px",i.style.minWidth="60px",t.appendChild(i),this.radiusSlider=document.createElement("input"),this.radiusSlider.type="range",this.radiusSlider.min=0,this.radiusSlider.max=100,this.radiusSlider.step=.01,this.radiusSlider.style.width=this.options.sliderWidth,this.radiusSlider.style.marginRight="10px",t.appendChild(this.radiusSlider),this.radiusInput=document.createElement("input"),this.radiusInput.type="number",this.radiusInput.style.width=this.options.inputWidth,this.radiusInput.style.padding="5px",this.radiusInput.style.backgroundColor="#333",this.radiusInput.style.color="#fff",this.radiusInput.style.border="1px solid #555",this.radiusInput.style.borderRadius="4px",this.radiusInput.step=.01,t.appendChild(this.radiusInput),this.radiusSlider.addEventListener("input",s=>{this.onSliderChange(parseFloat(s.target.value))}),this.radiusInput.addEventListener("change",s=>{this.onInputChange(parseFloat(s.target.value))}),e.appendChild(this.radiusValueContainer),e.appendChild(t),this.selectedModelIndex=0,this.updateRadiusControls()}else{const t=document.createElement("p");t.textContent="No models with radius controls found.",e.appendChild(t)}this.panel.appendChild(e)}updateRadiusControls(){const e=this.modelSelector?parseInt(this.modelSelector.value):0;if(this.selectedModelIndex=e,e>=0&&e<this.radiusModels.length){const t=this.radiusModels[e],i=t.radius;this.radiusValueContainer.textContent=`Model: ${t.name} (${parseFloat(i.value.toFixed(2))})`,this.radiusSlider.min=i.min||0,this.radiusSlider.max=i.max||100,this.radiusSlider.value=i.value,this.radiusInput.min=i.min||0,this.radiusInput.max=i.max||100,this.radiusInput.value=parseFloat(i.value.toFixed(2))}}onSliderChange(e){if(this.selectedModelIndex>=0&&this.selectedModelIndex<this.radiusModels.length){const i=this.radiusModels[this.selectedModelIndex].radius,s=parseFloat(e.toFixed(2));i.value=s,this.radiusInput.value=s}}onInputChange(e){if(this.selectedModelIndex>=0&&this.selectedModelIndex<this.radiusModels.length){const i=this.radiusModels[this.selectedModelIndex].radius,s=parseFloat(this.radiusSlider.min),o=parseFloat(this.radiusSlider.max),n=Math.max(s,Math.min(o,e)),r=parseFloat(n.toFixed(2));i.value=r,this.radiusSlider.value=r,r!==e&&(this.radiusInput.value=r)}}createHTMLToggleButton(){try{console.log("Creating radius control toggle button");let e=document.getElementById("toggleButtons");e||(e=document.getElementById("controlButtons")),e||(e=document.querySelector(".control-buttons-container")),e||(console.error("Toggle buttons container not found, creating new one"),e=document.createElement("div"),e.id="toggleButtons",e.style.position="absolute",e.style.bottom="20px",e.style.right="20px",e.style.display="flex",e.style.flexDirection="row",e.style.gap="10px",e.style.zIndex="100",document.body.appendChild(e));const t=document.createElement("button");t.id="radiusControlToggle",t.textContent="Radius",t.className="control-button",t.style.backgroundColor=this.options.isVisible?"#4CAF50":"#444444",t.style.color="#fff",t.style.border="none",t.style.padding="8px 16px",t.style.borderRadius="4px",t.style.cursor="pointer",t.style.fontWeight="bold",t.style.width="120px",t.style.textAlign="center",t.style.transition="background-color 0.3s",t.style.boxShadow="0 2px 4px rgba(0,0,0,0.3)",t.addEventListener("mouseover",()=>{t.style.backgroundColor=this.options.isVisible?"#45a049":"#555555"}),t.addEventListener("mouseout",()=>{t.style.backgroundColor=this.options.isVisible?"#4CAF50":"#444444"}),t.addEventListener("click",()=>{this.toggleVisible()}),e.appendChild(t),this.toggleButton=t,console.log("Radius control toggle button created successfully")}catch(e){console.error("Error creating radius control toggle button:",e)}}toggleVisible(){this.options.isVisible=!this.options.isVisible,this.toggleButton&&(this.toggleButton.style.backgroundColor=this.options.isVisible?"#4CAF50":"#444444"),this.panel&&(this.panel.style.display=this.options.isVisible?"block":"none")}update(){this.options.isVisible&&this.selectedModelIndex!==void 0&&this.updateRadiusControls()}}class pe{constructor(){this.init()}async init(){try{const{engine:e,canvas:t}=await q();this.engine=e,this.canvas=t;const{scene:i,shadowGenerator:s,axesViewer:o}=K(e);this.scene=i,this.shadowGenerator=s,this.axesViewer=o,this.cameraController=new le(i,t,{initialPosition:new h(0,1e3,200),zoomScaling:5,minDistance:20,maxDistance:3e3}),this.groundModel=new Z(i,2e3),this.ringModel=new ae(i,new h(0,0,0),{debug:!0}),this.starModel=new ie(i,new h(0,0,0),{debug:!0}),this.onRender();const n=[this.ringModel,this.starModel];this.sceneEditor=new he(i,n),this.uiController=new de(this.cameraController,{scene:this.scene,models:[this.ringModel,this.starModel],sceneEditor:this.sceneEditor,showDebugInfo:!0,showRadiusControl:!0,app:this,controlClasses:{DebugInfoView:ce,RadiusControl:ue},showOnlyDebugToggle:!0}),this.debugInfoView=this.uiController.debugInfoView,i.registerBeforeRender(()=>{const r=this.scene.activeCamera.position;this.ringModel.updateLOD(r),this.starModel.updateLOD(r),this.sceneEditor&&this.sceneEditor.update(),this.uiController&&this.uiController.update()}),this.startRenderLoop(),console.log("Initialization complete")}catch(e){console.error("Initialization error:",e),this.showError(`Initialization error: ${e.message}`)}}startRenderLoop(){this.engine.runRenderLoop(()=>{this.scene&&this.scene.render()}),window.cheDebug={app:this,models:{ringModel:this.ringModel,starModel:this.starModel},getStats:()=>!this.ringModel||!this.starModel?"Models not initialized yet":{cameraMode:this.cameraController?this.cameraController.currentMode:"unknown",fps:this.engine?this.engine.getFps().toFixed():"unknown",ringModel:{childCount:this.ringModel.childModels?this.ringModel.childModels.length:0,layerOneRadius:this.ringModel.layerOneRing&&this.ringModel.layerOneRing.options?this.ringModel.layerOneRing.options.radius.toFixed(1):"unknown",layerTwoRadius:this.ringModel.layerTwoRing&&this.ringModel.layerTwoRing.options?this.ringModel.layerTwoRing.options.radius.toFixed(1):"unknown",layerThreeRadius:this.ringModel.layerThreeRing&&this.ringModel.layerThreeRing.options?this.ringModel.layerThreeRing.options.radius.toFixed(1):"unknown",layerFourRadius:this.ringModel.layerFourRing&&this.ringModel.layerFourRing.options?this.ringModel.layerFourRing.options.radius.toFixed(1):"unknown",layerFiveRadius:this.ringModel.layerFiveRing&&this.ringModel.layerFiveRing.options?this.ringModel.layerFiveRing.options.radius.toFixed(1):"unknown"},starModel:{childCount:this.starModel.childModels?this.starModel.childModels.length:0,radius:this.starModel.options?this.starModel.options.outerRadius:"unknown",layerOneRadius:this.starModel.layerOneStar&&this.starModel.layerOneStar.options?this.starModel.layerOneStar.options.radius.toFixed(1):"unknown",layerTwoRadius:this.starModel.layerTwoStar&&this.starModel.layerTwoStar.options?this.starModel.layerTwoStar.options.radius.toFixed(1):"unknown",layerThreeRadius:this.starModel.layerThreeStar&&this.starModel.layerThreeStar.options?this.starModel.layerThreeStar.options.radius.toFixed(1):"unknown",layerFourRadius:this.starModel.layerFourStar&&this.starModel.layerFourStar.options?this.starModel.layerFourStar.options.radius.toFixed(1):"unknown"}},forceUpdatePositions:()=>{if(console.log("Forcing complete recalculation of all positions..."),this.ringModel&&typeof this.ringModel.updateRadiusSettings=="function"){const e=this.ringModel.layerFiveRing&&this.ringModel.layerFiveRing.options?this.ringModel.layerFiveRing.options.radius:182,t=this.ringModel.options?this.ringModel.options.singleCutRadius:21;this.ringModel.updateRadiusSettings(e,t),console.log(`Updated Ring Model positions with outer radius=${e}`)}if(this.starModel&&typeof this.starModel.updateRadiusSettings=="function"){const e=this.starModel.options?this.starModel.options.outerRadius:72.52,t=this.starModel.options?this.starModel.options.singleCutRadius:21;this.starModel.updateRadiusSettings(e,t),console.log(`Updated Star Model positions with outer radius=${e}`)}return"Force updated all model positions"},help:()=>{console.log(`
CHE Visualization Debug Console Commands:
----------------------------------------
cheDebug.getStats() - Get basic statistics about models
cheDebug.forceUpdatePositions() - Force complete recalculation and update of positions
cheDebug.models - Access all models directly
cheDebug.app - Access the main application instance
`)}},console.log("%c CHE Visualization Debug Tools Available","background: #222; color: #bada55; font-size: 14px; padding: 5px;"),console.log("%c Use cheDebug.help() for available commands","color: #bada55;")}showError(e){const t=document.createElement("div");t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.backgroundColor="rgba(255, 0, 0, 0.7)",t.style.color="white",t.style.padding="20px",t.style.borderRadius="5px",t.style.zIndex="1000",t.innerHTML=`
            <h3>Error</h3>
            <p>${e}</p>
            <p>Please check your browser console for more details.</p>
            <div id="webglInfo"></div>
        `,document.body.appendChild(t);const i=document.getElementById("webglInfo");try{const s=document.createElement("canvas"),o=s.getContext("webgl")||s.getContext("experimental-webgl");if(o){const n=o.getExtension("WEBGL_debug_renderer_info"),r=n?o.getParameter(n.UNMASKED_RENDERER_WEBGL):"Unknown";i.innerHTML=`<p>WebGL Renderer: ${r}</p>`}else i.innerHTML="<p>WebGL not available in your browser</p>"}catch(s){i.innerHTML=`<p>Could not get WebGL information: ${s.message}</p>`}}onRender(){console.log("Initializing models after scene setup");const e=t=>{t&&typeof t.onRender=="function"&&t.onRender(),t&&t.childModels&&Array.isArray(t.childModels)&&t.childModels.forEach(i=>{e(i)})};this.ringModel&&e(this.ringModel),this.starModel&&e(this.starModel),console.log("Model initialization complete")}}document.addEventListener("DOMContentLoaded",()=>{new pe});
